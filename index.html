<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CallBridge Virtual Dialer</title>
<style>
body { font-family: sans-serif; background: #f5f5f5; text-align: center; }
.card { background: white; border-radius: 10px; padding: 20px; margin: 20px auto; width: 320px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
input, button { padding: 10px; width: 90%; margin: 6px; border-radius: 5px; border: 1px solid #ccc; }
#profile, #dialer { display: none; }
</style>
</head>
<body>

<div class="card" id="login">
  <h2>Login</h2>
  <input id="email" type="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button onclick="performLogin()">Login</button>
  <p id="loginStatus"></p>
</div>

<div class="card" id="profile">
  <h3 id="pName"></h3>
  <p>Email: <span id="pEmail"></span></p>
  <p>Number: <span id="pNumber"></span></p>
  <p>Expires: <span id="pExpiry"></span></p>
  <button onclick="showDialer()">Open Dialer</button>
</div>

<div class="card" id="dialer">
  <h3>Dial Pad</h3>
  <input id="callNumber" placeholder="+1..." />
  <button onclick="simulateCall()">Call</button>
  <button onclick="logout()">Logout</button>
  <p id="callStatus"></p>
</div>

<script>
const API_BASE = "https://callbridge.onrender.com";
let currentUser = null;

async function performLogin() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();
  document.getElementById("loginStatus").innerText = "Checking...";
  try {
    const res = await fetch(API_BASE + "/login", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({email, password})
    });
    const data = await res.json();
    if (res.ok && data.user) {
      currentUser = data.user;
      localStorage.setItem("currentUser", JSON.stringify(currentUser));
      document.getElementById("login").style.display = "none";
      showProfile();
    } else {
      document.getElementById("loginStatus").innerText = data.error || "Login failed";
    }
  } catch (err) {
    document.getElementById("loginStatus").innerText = "Network error";
  }
}

async function showProfile() {
  const u = currentUser;
  if (!u) return;
  document.getElementById("pName").innerText = u.display_name;
  document.getElementById("pEmail").innerText = u.email;
  document.getElementById("pNumber").innerText = u.assigned_number;
  document.getElementById("pExpiry").innerText = u.expiry_date;
  document.getElementById("profile").style.display = "block";
}

function showDialer() {
  document.getElementById("profile").style.display = "none";
  document.getElementById("dialer").style.display = "block";
}

async function simulateCall() {
  const num = document.getElementById("callNumber").value.trim();
  if (!num) { alert("Enter number"); return; }
  document.getElementById("callStatus").innerText = "Connecting...";
  const res = await fetch(API_BASE + "/simulate-call", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({to: num})
  });
  const data = await res.json();
  document.getElementById("callStatus").innerText = data.message || "Simulated call complete.";
}

function logout() {
  localStorage.removeItem("currentUser");
  currentUser = null;
  document.getElementById("dialer").style.display = "none";
  document.getElementById("profile").style.display = "none";
  document.getElementById("login").style.display = "block";
}
</script>

</body>
</html>
