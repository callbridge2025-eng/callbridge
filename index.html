<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Call Bridge ‚Äî Tech Talk Titans</title>

  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --green:#10b981;
      --danger:#ef4444; --shadow:0 8px 30px rgba(2,6,23,0.08);
    }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Arial;}
    html,body{height:100%;margin:0;background:var(--bg)}
    body{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;padding:18px}
    .panel{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);height:calc(100vh - 36px);overflow:auto}
    h2{margin:0 0 8px 0}
    .muted{color:var(--muted);font-size:13px}
    #left{display:flex;flex-direction:column;gap:12px;align-items:center}
    input#dialInput{width:220px;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:16px}
    .key-row{display:flex;gap:8px;margin-top:8px}
    .key{width:64px;height:64px;border-radius:10px;border:1px solid #e6e9ef;background:#fafbff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .key.primary{background:var(--accent);color:#fff;border:none}
    .controls{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;color:#fff}
    .btn.call{background:var(--green)} .btn.hang{background:var(--danger)} .btn.gray{background:#374151}
    #activeArea{display:none;flex-direction:column;align-items:center;gap:8px}
    #waveWrap{display:flex;gap:6px;align-items:flex-end;height:40px}
    #historyList{display:flex;flex-direction:column;gap:10px}
    .history-item{padding:10px;border-radius:10px;border:1px solid #eef2ff;background:#fff;display:flex;justify-content:space-between;align-items:center}
    .badge{padding:6px 8px;border-radius:999px;background:#f1f5f9;font-size:12px;color:var(--muted)}
    .profile-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #f3f4f6}
    #incomingModal,#loginModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:9999;align-items:center;justify-content:center}
    .modalCard{background:white;padding:22px;border-radius:12px;width:360px;text-align:center;box-shadow:0 12px 40px rgba(2,6,23,0.12)}
    .modalBtns{display:flex;gap:12px;justify-content:center;margin-top:12px}
    .ringDot{width:72px;height:72px;border-radius:50%;background:var(--green);margin:10px auto;animation:pulse 1.2s infinite}
    @keyframes pulse {0%{transform:scale(0.95);opacity:0.8}50%{transform:scale(1.08);opacity:1}100%{transform:scale(0.95);opacity:0.8}}
  </style>
</head>

<body>
  <!-- LEFT PANEL -->
  <div class="panel" id="left">
    <h2>Dial Pad</h2>
    <input id="dialInput" placeholder="Enter number"/>
    <div id="dialPad">
      <div class="key-row"><div class="key">1</div><div class="key">2</div><div class="key">3</div></div>
      <div class="key-row"><div class="key">4</div><div class="key">5</div><div class="key">6</div></div>
      <div class="key-row"><div class="key">7</div><div class="key">8</div><div class="key">9</div></div>
      <div class="key-row"><div class="key">*</div><div class="key">0</div><div class="key">#</div></div>
    </div>
    <div class="controls">
      <button class="btn call" id="callBtn">Call</button>
    </div>

    <div id="activeArea">
      <p id="callerNumber"></p>
      <div class="controls">
        <button class="btn gray" id="muteBtn">Mute</button>
        <button class="btn gray" id="holdBtn">Hold</button>
        <button class="btn hang" id="hangupBtn">Hangup</button>
      </div>
    </div>
  </div>

  <!-- MIDDLE PANEL -->
  <div class="panel">
    <h2>Call History</h2>
    <div id="historyList"><p class="muted">Loading...</p></div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="panel">
    <h2>User Profile</h2>
    <div id="profileBox"></div>
  </div>

  <!-- INCOMING MODAL -->
  <div id="incomingModal">
    <div class="modalCard">
      <h3>Incoming Call</h3>
      <div class="ringDot"></div>
      <p id="incomingFrom"></p>
      <div class="modalBtns">
        <button class="btn call" id="answerBtn">Answer</button>
        <button class="btn hang" id="declineBtn">Decline</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal">
    <div class="modalCard">
      <h3>Login</h3>
      <label>Email</label><br/>
      <input id="email" type="email" placeholder="Enter email"/>
      <label>Password</label><br/>
      <input id="password" type="password" placeholder="Enter password"/>
      <button class="btn call" id="loginBtn">Login</button>
    </div>
  </div>

  <audio id="ringtoneAudio" preload="auto"></audio>

<script>
const API_BASE = "https://callbridge.onrender.com";
let device, incomingConn, activeConn, currentUser;

async function loadTwilioSDK(){
  return new Promise((resolve,reject)=>{
    if(window.Twilio?.Device) return resolve();
    const s=document.createElement("script");
    s.src="https://sdk.twilio.com/js/voice/releases/2.0.1/twilio.min.js";
    s.onload=()=>window.Twilio?.Device?resolve():reject("Twilio SDK failed");
    s.onerror=()=>reject("Twilio SDK failed");
    document.head.appendChild(s);
  });
}

async function initTwilioDevice(token){
  await loadTwilioSDK();
  if(!token) return console.error("No token found");
  device=new Twilio.Device(token,{codecPreferences:["opus","pcmu"],debug:false});
  device.on("ready",()=>console.log("‚úÖ Twilio ready"));
  device.on("error",(e)=>console.error("Twilio error:",e));
  device.on("incoming",(conn)=>{
    incomingConn=conn;
    document.getElementById("incomingFrom").innerText="From: "+(conn.parameters?.From||"Unknown");
    document.getElementById("incomingModal").style.display="flex";
    const r=document.getElementById("ringtoneAudio");
    r.src="https://actions.google.com/sounds/v1/alarms/bugle_tune.ogg";
    r.loop=true;r.play().catch(()=>{});
  });
}

async function login(email,pwd){
  const res=await fetch(`${API_BASE}/login`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email,password:pwd})
  });
  if(!res.ok){alert("Login failed");return;}
  const json=await res.json();
  currentUser=json;
  localStorage.setItem("session",JSON.stringify(json));
  document.getElementById("loginModal").style.display="none";
  await initTwilioDevice(json.token);
  loadProfile();loadHistory();
}

function loadProfile(){
  const box=document.getElementById("profileBox");
  if(!currentUser)return;
  box.innerHTML=`
    <div class='profile-row'><b>Name:</b><span>${currentUser.display_name}</span></div>
    <div class='profile-row'><b>Email:</b><span>${currentUser.email}</span></div>
    <div class='profile-row'><b>Number:</b><span>${currentUser.assigned_number}</span></div>
    <div class='profile-row'><b>Role:</b><span>${currentUser.role}</span></div>
    <div class='profile-row'><b>Expiry:</b><span>${currentUser.expiry_date}</span></div>`;
}

async function loadHistory(){
  const r=await fetch(`${API_BASE}/call-logs/${currentUser.email}`);
  const data=await r.json();
  const list=document.getElementById("historyList");
  list.innerHTML=data.map(d=>`
    <div class='history-item'>
      <div>
        <b>${d.To}</b><br><span class='muted'>${d.CallType}</span>
      </div>
      <div class='badge'>${d.Duration}s</div>
    </div>`).join('');
}

document.getElementById("loginBtn").onclick=()=>{
  login(document.getElementById("email").value,document.getElementById("password").value);
};

document.getElementById("callBtn").onclick=async()=>{
  const num=document.getElementById("dialInput").value.trim();
  if(!num)return alert("Enter number");
  if(!device)return alert("Device not ready");
  activeConn=device.connect({params:{To:num}});
  document.getElementById("dialPad").style.display="none";
  document.getElementById("activeArea").style.display="flex";
};

document.getElementById("hangupBtn").onclick=()=>{
  if(activeConn)activeConn.disconnect();
  document.getElementById("dialPad").style.display="block";
  document.getElementById("activeArea").style.display="none";
};

document.getElementById("answerBtn").onclick=()=>{
  if(incomingConn){incomingConn.accept();}
  document.getElementById("incomingModal").style.display="none";
};

document.getElementById("declineBtn").onclick=()=>{
  if(incomingConn){incomingConn.reject();}
  document.getElementById("incomingModal").style.display="none";
};

document.querySelectorAll(".key").forEach(k=>k.onclick=()=>{document.getElementById("dialInput").value+=k.innerText;});

(async function init(){
  console.log("üîÅ Initializing app...");
  const saved=localStorage.getItem("session");
  if(saved){
    currentUser=JSON.parse(saved);
    await initTwilioDevice(currentUser.token);
    loadProfile();loadHistory();
  }else{
    document.getElementById("loginModal").style.display="flex";
  }
})();
</script>
</body>
</html>
