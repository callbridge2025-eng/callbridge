<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Call Bridge â€” Tech Talk Titans</title>

  <!-- âœ… Twilio Client SDK v2 -->
  <script src="https://media.twiliocdn.com/sdk/js/client/v2.0/twilio.min.js"></script>

  <style>
    :root {
      --bg:#f4f6f9; --card:#fff; --muted:#6b7280;
      --accent:#2563eb; --green:#10b981; --danger:#ef4444;
      --shadow:0 8px 30px rgba(2,6,23,0.08);
    }
    body {
      margin:0; background:var(--bg); font-family:system-ui,sans-serif;
      color:#111; display:flex; flex-direction:column; align-items:center;
    }
    header {
      background:var(--accent); color:#fff; width:100%;
      text-align:center; padding:1rem; font-size:1.25rem; font-weight:600;
      box-shadow:var(--shadow);
    }
    #app {
      width:100%; max-width:450px; margin:2rem auto; padding:1.5rem;
      background:var(--card); border-radius:1rem; box-shadow:var(--shadow);
    }
    button {
      padding:0.75rem 1.25rem; border:none; border-radius:0.75rem;
      font-weight:600; cursor:pointer; transition:0.2s;
    }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .btn-accent { background:var(--accent); color:#fff; }
    .btn-green { background:var(--green); color:#fff; }
    .btn-danger { background:var(--danger); color:#fff; }
    #history div {
      border-bottom:1px solid #eee; padding:0.5rem 0;
    }
  </style>
</head>

<body>
  <header>ðŸ“ž Call Bridge â€” Tech Talk Titans</header>

  <div id="app">
    <h2 id="user-name">Loading profileâ€¦</h2>
    <p id="user-email" class="muted"></p>

    <input id="call-to" placeholder="Enter phone number" style="width:100%;padding:0.5rem;border:1px solid #ccc;border-radius:0.5rem;margin-top:1rem;">
    <div style="display:flex;gap:0.5rem;margin-top:1rem;">
      <button id="call-btn" class="btn-green">Start Call</button>
      <button id="hangup-btn" class="btn-danger" disabled>Hang Up</button>
    </div>

    <h3 style="margin-top:2rem;">Call History</h3>
    <div id="history">Loadingâ€¦</div>
  </div>

  <script>
    const API_BASE = "https://callbridge.onrender.com";
    let device = null;
    let currentConnection = null;

    // === Auto-login and profile ===
    async function loadProfile() {
      try {
        const res = await fetch(`${API_BASE}/profile`, { credentials: "include" });
        if (!res.ok) throw new Error("Profile failed");
        const data = await res.json();
        document.getElementById("user-name").textContent = data.name || "User";
        document.getElementById("user-email").textContent = data.email || "";
        await initTwilioDevice(data.email);
        refreshHistory();
      } catch (e) {
        console.error("Profile load error", e);
        document.getElementById("user-name").textContent = "Login required";
      }
    }

    // === Twilio Device setup ===
    async function initTwilioDevice(identity) {
      try {
        const res = await fetch(`${API_BASE}/twilio-token?identity=${encodeURIComponent(identity)}`);
        const json = await res.json();
        if (!json.token) throw new Error("No Twilio token received");

        if (typeof Twilio === "undefined" || !Twilio.Device) {
          throw new Error("Twilio SDK not loaded");
        }

        device = new Twilio.Device(json.token, {
          codecPreferences: ["opus", "pcmu"],
          debug: true
        });

        device.on("ready", () => console.log("âœ… Twilio Device ready"));
        device.on("error", err => console.error("Twilio Device error:", err));
        device.on("connect", conn => {
          console.log("ðŸ”Š Connected");
          currentConnection = conn;
          document.getElementById("hangup-btn").disabled = false;
        });
        device.on("disconnect", () => {
          console.log("ðŸ“´ Disconnected");
          currentConnection = null;
          document.getElementById("hangup-btn").disabled = true;
          refreshHistory();
        });
        device.on("incoming", conn => {
          console.log("ðŸ“ž Incoming call");
          if (confirm("Accept incoming call?")) conn.accept();
          else conn.reject();
        });

      } catch (e) {
        console.error("Twilio device init failed:", e);
        alert("Twilio init failed. See console.");
      }
    }

    // === Make Call ===
    async function startCall() {
      const number = document.getElementById("call-to").value.trim();
      if (!number) return alert("Enter a number first.");
      if (!device) return alert("Twilio not ready.");
      try {
        currentConnection = device.connect({ params: { To: number } });
        document.getElementById("hangup-btn").disabled = false;
        await remoteSaveCall(number, "outgoing");
      } catch (err) {
        console.error("Start call error", err);
        alert("Failed to start call.");
      }
    }

    // === Hangup ===
    function hangUp() {
      if (currentConnection) currentConnection.disconnect();
      document.getElementById("hangup-btn").disabled = true;
    }

    // === History ===
    async function refreshHistory() {
      try {
        const res = await fetch(`${API_BASE}/calls`, { credentials: "include" });
        if (!res.ok) throw new Error("History fetch failed");
        const calls = await res.json();
        const hist = document.getElementById("history");
        hist.innerHTML = "";
        if (!calls.length) return (hist.textContent = "No calls yet.");
        for (const c of calls)
          hist.innerHTML += `<div>ðŸ“ž ${c.direction} ${c.number} â€” ${new Date(c.time).toLocaleString()}</div>`;
      } catch (e) {
        console.error("refreshHistory error", e);
      }
    }

    // === Save Call to backend ===
    async function remoteSaveCall(number, direction) {
      try {
        const res = await fetch(`${API_BASE}/save-call`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ number, direction }),
          credentials: "include"
        });
        if (!res.ok) throw new Error("Save failed");
      } catch (err) {
        console.warn("Call save failed", err);
      }
    }

    // === UI handlers ===
    document.getElementById("call-btn").onclick = startCall;
    document.getElementById("hangup-btn").onclick = hangUp;

    // === Initialize ===
    window.addEventListener("load", loadProfile);
  </script>
</body>
</html>
