<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Call Bridge â€” Tech Talk Titans</title>

  <!-- Twilio Voice SDK v2 -->
  <script src="https://unpkg.com/@twilio/voice-sdk@2.16.0/dist/twilio.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>

  <style>
    :root{ --bg:#f4f6f9; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --green:#10b981; --danger:#ef4444; --shadow:0 8px 30px rgba(2,6,23,0.08); }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Arial;}
    html,body{height:100%;margin:0;background:var(--bg)}
    body{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;padding:18px}
    .panel{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);height:calc(100vh - 36px);overflow:auto}
    h2{margin:0 0 8px 0} .muted{color:var(--muted);font-size:13px}
    #left{display:flex;flex-direction:column;gap:12px;align-items:center}
    #callerNumber{font-weight:700;color:#111827;} input#dialInput{width:220px;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:16px}
    .key-row{display:flex;gap:8px;margin-top:8px}
    .key{width:64px;height:64px;border-radius:10px;border:1px solid #e6e9ef;background:#fafbff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .key.primary{background:var(--accent);color:#fff;border:none}
    .controls{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;color:#fff}
    .btn.call{background:var(--green)} .btn.hang{background:var(--danger)} .btn.gray{background:#374151}
    #activeArea{display:none;flex-direction:column;align-items:center;gap:8px}
    #waveWrap{display:flex;gap:6px;align-items:flex-end;height:40px}
    #historyList{display:flex;flex-direction:column;gap:10px}
    .history-item{padding:10px;border-radius:10px;border:1px solid #eef2ff;background:#fff;display:flex;justify-content:space-between;align-items:center}
    .badge{padding:6px 8px;border-radius:999px;background:#f1f5f9;font-size:12px;color:var(--muted)}
    .profile-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #f3f4f6}
    #incomingModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:9999;align-items:center;justify-content:center}
    .modalCard{background:white;padding:22px;border-radius:12px;width:360px;text-align:center;box-shadow:0 12px 40px rgba(2,6,23,0.12)}
    .modalBtns{display:flex;gap:12px;justify-content:center;margin-top:12px}
    @keyframes pulse{0%{transform:scale(0.95);opacity:0.8}50%{transform:scale(1.08);opacity:1}100%{transform:scale(0.95);opacity:0.8}}
    .ringDot{width:72px;height:72px;border-radius:50%;background:var(--green);margin:10px auto;animation:pulse 1.2s infinite}
    @media (max-width: 900px){
      html, body { height: 100%; overflow: hidden; }
      body{display:flex;flex-direction:row;gap:0;padding:0;overflow-x:auto;overflow-y:hidden;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;background:var(--bg)}
      .panel{min-width:100vw;height:100vh;border-radius:0;box-shadow:none;scroll-snap-align:start;padding:16px}
    }
    #loginModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:10000;align-items:center;justify-content:center}
    #loginModal .modalCard{width:360px;text-align:left;}
    #loginModal input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-top:8px;}
  </style>
</head>
<body>

  <!-- LEFT -->
  <div id="left" class="panel">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
      <h2>Call Bridge</h2><div class="muted">Tech Talk Titans</div>
    </div>
    <div style="text-align:center">
      <div class="muted">Your Virtual Number</div>
      <div id="callerNumber">Loading...</div>
    </div>

    <div id="dialpadArea" style="display:flex;flex-direction:column;align-items:center;margin-top:6px">
      <input id="dialInput" type="tel" inputmode="tel" pattern="^\+?\d[\d\s\-()]*$" placeholder="+1..." />
      <div style="margin-top:12px">
        <div class="key-row"><button class="key" data-key="1">1</button><button class="key" data-key="2">2</button><button class="key" data-key="3">3</button></div>
        <div class="key-row"><button class="key" data-key="4">4</button><button class="key" data-key="5">5</button><button class="key" data-key="6">6</button></div>
        <div class="key-row"><button class="key" data-key="7">7</button><button class="key" data-key="8">8</button><button class="key" data-key="9">9</button></div>
        <div class="key-row"><button class="key" data-key="+">+</button><button class="key" data-key="0">0</button><button class="key" data-key="#">#</button></div>
      </div>
      <div class="controls" style="margin-top:12px"><button id="startCallBtn" class="btn call">ðŸ“ž Call</button></div>
    </div>

    <div id="activeArea">
      <div id="activeLabel" style="font-weight:700">In Call</div>
      <div id="callTimer" class="muted">00:00</div>
      <div id="waveWrap"></div>
      <div class="controls" style="margin-top:10px">
        <button id="muteBtn" class="btn gray">Mute</button>
        <button id="holdBtn" class="btn gray">Hold</button>
        <button id="speakerBtn" class="btn gray">Speaker On</button>
        <button id="hangupBtn" class="btn hang" style="display:none">âœ– Hangup</button>
      </div>
    </div>
  </div>

  <!-- MIDDLE -->
  <div id="middle" class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Call History</h2><div class="muted">Latest</div>
    </div>
    <div id="historyList" style="margin-top:12px"><div class="muted">Loading call history...</div></div>
  </div>

  <!-- RIGHT -->
  <div id="right" class="panel">
    <h2>My Profile</h2>
    <div class="profile-row"><div class="muted">Email</div><div id="pEmail">Loading...</div></div>
    <div class="profile-row"><div class="muted">Assigned Number</div><div id="pNumber">Loading...</div></div>
    <div class="profile-row"><div class="muted">Status</div><div id="pStatus">Loading...</div></div>
    <div class="profile-row"><div class="muted">Valid Until</div><div id="pExpiry">Loading...</div></div>
    <div style="margin-top:14px"><button id="logoutBtn" class="btn hang" style="width:100%">Logout</button></div>

    <div style="margin-top:12px;font-size:13px;text-align:center;color:var(--muted)">
      <div style="font-weight:600;color:#111827">Contact Support</div>
      <div>ðŸ“ž +1(803)346-6904</div>
      <div>ðŸ“§ <a href="mailto:callbridge.2025@gmail.com" style="color:var(--accent);text-decoration:none">callbridge.2025@gmail.com</a></div>
    </div>
  </div>

  <!-- Incoming Call Modal -->
  <div id="incomingModal" style="display:none;align-items:center;justify-content:center">
    <div class="modalCard">
      <div style="font-weight:700;font-size:18px">Incoming Call</div>
      <div id="incomingFrom" class="muted" style="margin-top:6px">From: â€”</div>
      <div class="ringDot"></div>
      <div class="modalBtns">
        <button id="answerBtn" class="btn call">Answer</button>
        <button id="declineBtn" class="btn hang">Decline</button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" style="display:none;align-items:center;justify-content:center">
    <div class="modalCard">
      <div style="font-weight:700;font-size:18px">Sign in</div>
      <div class="muted" style="margin-top:6px">Use your email & password. Verify your email to enable calling.</div>
      <input id="loginEmail" placeholder="Email" type="email" />
      <input id="loginPassword" placeholder="Password" type="password" />
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="loginBtn" class="btn call" style="flex:1" type="button">Login</button>
        <button id="sendVerifyBtn" class="btn gray" style="flex:1" type="button">Send Verify Email</button>
      </div>
      <div id="loginError" class="muted" style="color:var(--danger);margin-top:10px;display:none"></div>

      <div style="margin-top:14px;font-size:13px;text-align:center;color:var(--muted)">
        <div style="font-weight:600;color:#111827">Contact Support</div>
        <div>ðŸ“ž +1(803)346-6904</div>
        <div>ðŸ“§ <a href="mailto:callbridge.2025@gmail.com" style="color:var(--accent);text-decoration:none">callbridge.2025@gmail.com</a></div>
      </div>
    </div>
  </div>

  <!-- Ringtone -->
  <audio id="ringtoneAudio" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" preload="auto"></audio>

<script>
/* ================= CONFIG ================= */
const API_BASE = "https://callbridge.onrender.com";

/* Firebase config â€” REPLACE with your project values */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
});
const auth = firebase.auth();

/* small helpers */
const $ = id => document.getElementById(id);
const setText = (id, txt) => { const el = $(id); if (el) el.innerText = txt; };

/* phone display formatter */
function showE164(n){
  if (n == null) return 'â€”';
  const raw = String(n).trim();
  if (raw === '') return 'â€”';
  let e164 = raw;
  if (!raw.startsWith('+')) {
    if (/^\d{10}$/.test(raw)) e164 = `+1${raw}`;
    else if (/^\d{11,15}$/.test(raw)) e164 = `+${raw}`;
  }
  const m = /^\+1(\d{3})(\d{3})(\d{4})$/.exec(e164);
  if (m) return `(${m[1]}) ${m[2]}-${m[3]}`;
  return e164;
}

/* app state */
let device = null, inCall = false, activeConn = null, incomingConn = null;
let currentUser = null, assignedNumber = ""; let callStartTs = 0;
let timerInterval = null, wfRaf = null, historyPollInterval = null, localStream = null;

/* auth headers from Firebase ID token */
async function authHeaders(){
  const u = auth.currentUser;
  if(!u) return {};
  const t = await u.getIdToken();
  return { "Authorization": "Bearer " + t };
}

/* mic permission */
async function ensureMic(){
  if (!navigator.mediaDevices?.getUserMedia) { alert("Microphone APIs unavailable."); return false; }
  try{ localStream = await navigator.mediaDevices.getUserMedia({ audio:true }); return true; }
  catch{ return false; }
}

/* Login modal */
function showLoginModal(){ $("loginModal").style.display = "flex"; }
function hideLoginModal(){ $("loginModal").style.display = "none"; }

/* Firebase login */
async function performLogin(){
  $("loginError").style.display = "none";
  const email = $("loginEmail").value.trim();
  const password = $("loginPassword").value;
  if(!email || !password){ $("loginError").innerText="Enter email & password"; $("loginError").style.display="block"; return; }
  try{
    await auth.signInWithEmailAndPassword(email, password);
    await auth.currentUser.reload();
    if(!auth.currentUser.emailVerified){
      $("loginError").innerText = "Verification email sent if not already. Please verify your email.";
      $("loginError").style.display = "block";
      try { await auth.currentUser.sendEmailVerification(); } catch {}
      return;
    }
    hideLoginModal();
    await postLoginInit();
  }catch(e){
    $("loginError").innerText = e.message || "Login failed";
    $("loginError").style.display = "block";
  }
}

async function sendVerify(){
  try{
    const email = $("loginEmail").value.trim();
    const password = $("loginPassword").value;
    if(!auth.currentUser){
      if(!email || !password){ $("loginError").innerText="Enter email & password first"; $("loginError").style.display="block"; return; }
      await auth.signInWithEmailAndPassword(email, password);
    }
    await auth.currentUser.sendEmailVerification();
    $("loginError").innerText = "Verification email sent. Please check your inbox.";
    $("loginError").style.display = "block";
  }catch(e){
    $("loginError").innerText = e.message || "Failed to send verification email";
    $("loginError").style.display = "block";
  }
}

async function performLogout(){
  try{ await auth.signOut(); } catch {}
  currentUser = null;
  if (historyPollInterval) clearInterval(historyPollInterval);
  try { if (device) device.destroy(); } catch {}
  device = null;
  showLoginModal();
}

/* save call to backend */
async function remoteSaveCall(payload){
  try{
    const res = await fetch(`${API_BASE}/save-call`, {
      method: "POST",
      headers: Object.assign({ "Content-Type":"application/json" }, await authHeaders()),
      body: JSON.stringify(payload)
    });
    if(!res.ok) console.warn("Save failed", res.status);
  }catch(e){ console.warn("Save call error", e); }
}

/* profile */
async function loadProfile(){
  try{
    const email = auth.currentUser?.email;
    if(!email) return;
    const res = await fetch(`${API_BASE}/profile`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ email })
    });
    if(!res.ok) return;
    const p = await res.json();
    currentUser = p;
    setText("pEmail", p.email || "â€”");
    setText("pNumber", showE164(p.assigned_number));
    setText("pStatus", p.role || "Active");
    setText("pExpiry", p.expiry_date ? new Date(p.expiry_date).toLocaleString() : "â€”");
    assignedNumber = p.assigned_number || "";
    setText("callerNumber", showE164(assignedNumber));
  }catch(e){ console.error("loadProfile error", e); }
}

/* Twilio device init */
async function safeInitTwilioDevice(tokenJson){
  try{
    let tries = 0;
    while ((typeof Twilio === "undefined" || !Twilio.Device) && tries < 10){
      await new Promise(r => setTimeout(r, 500)); tries++;
    }
    if (!tokenJson?.token || !Twilio?.Device) return;

    assignedNumber = tokenJson.callerId || assignedNumber; setText("callerNumber", assignedNumber || "â€”");
    try { if(device){ device.destroy(); device = null; } } catch(e){}

    device = new Twilio.Device(tokenJson.token, { codecPreferences: ["opus","pcmu"], debug:false });
    device.register();

    device.on("incoming", (connection) => {
      incomingConn = connection;
      $("incomingFrom").innerText = "From: " + showE164(connection.parameters?.From || "");
      $("incomingModal").style.display = "flex";
      const rt = $("ringtoneAudio"); try { rt.currentTime=0; rt.loop=true; rt.play().catch(()=>{}); } catch {}
    });
  }catch(e){ console.error("safeInitTwilioDevice error", e); }
}

async function initTwilioDevice(){
  try{
    const res = await fetch(`${API_BASE}/twilio-token`, {
      method: "POST",
      headers: Object.assign({ "Content-Type":"application/json" }, await authHeaders()),
      body: JSON.stringify({})
    });
    if(!res.ok){ console.error("/twilio-token", res.status); return; }
    const json = await res.json();
    await safeInitTwilioDevice(json);
  }catch(e){ console.error("initTwilioDevice error", e); }
}

/* outgoing call */
async function startCall(){
  const number = $("dialInput").value.trim();
  if(!number) return alert("Enter a number to call.");
  if(!auth.currentUser){ showLoginModal(); return; }
  await auth.currentUser.reload();
  if(!auth.currentUser.emailVerified){ alert("Verify your email first."); return; }

  if(!localStream){ const ok = await ensureMic(); if(!ok) return alert("Allow microphone to place calls."); }
  if(!device){ await initTwilioDevice(); if(!device) return alert("Twilio device init failed."); }

  try{
    await remoteSaveCall({
      user_email: auth.currentUser.email,
      call_type: "outgoing",
      from_number: assignedNumber || "",
      to_number: number,
      status: "initiated",
      created_at: new Date().toISOString()
    });

    const conn = device.connect({ params: { To: number } });
    activeConn = conn || null;

    $("dialpadArea").style.display = "none";
    $("activeArea").style.display = "flex";
    $("hangupBtn").style.display = "inline-block";
    inCall = true; setText("activeLabel", showE164(number) || "In Call");
    startTimer(); renderWaveform();
    try{ const rt = $("ringtoneAudio"); rt.pause(); rt.currentTime=0; } catch{}

    if(activeConn?.on){
      activeConn.on("accept", ()=>{ callStartTs = Date.now(); });
      activeConn.on("disconnect", async ()=>{
        const duration = Math.max(0, Math.floor((Date.now() - callStartTs)/1000));
        await remoteSaveCall({
          user_email: auth.currentUser.email,
          call_type: "outgoing",
          from_number: assignedNumber || "",
          to_number: number,
          status: "completed",
          created_at: new Date().toISOString(),
          duration
        });
        stopCallUI(); refreshHistory();
      });
      activeConn.on("error", ()=>{ stopCallUI(); });
    }
  }catch{ alert("Failed to start call."); }
}

/* incoming */
async function answerIncoming(){
  if(!incomingConn) return;
  try{
    try{ const rt=$("ringtoneAudio"); rt.pause(); rt.currentTime=0; }catch{}
    $("incomingModal").style.display="none";
    if(!localStream){ const ok = await ensureMic(); if(!ok){ alert("Allow microphone to answer."); return; } }
    incomingConn.accept?.(); activeConn = incomingConn; incomingConn = null;

    $("dialpadArea").style.display="none"; $("activeArea").style.display="flex";
    $("hangupBtn").style.display="inline-block"; inCall = true;
    setText("activeLabel", showE164(activeConn.parameters?.From || "") || "In Call");
    startTimer(); renderWaveform();

    await remoteSaveCall({
      user_email: auth.currentUser.email,
      call_type: "incoming",
      from_number: activeConn.parameters?.From || "",
      to_number: assignedNumber || "",
      status: "answered",
      created_at: new Date().toISOString()
    });

    if(activeConn?.on){
      activeConn.on("disconnect", async ()=>{
        const duration = Math.max(0, Math.floor((Date.now() - callStartTs)/1000));
        await remoteSaveCall({
          user_email: auth.currentUser.email,
          call_type: "incoming",
          from_number: activeConn.parameters?.From || "",
          to_number: assignedNumber || "",
          status: "completed",
          created_at: new Date().toISOString(),
          duration
        });
        stopCallUI(); refreshHistory();
      });
    }
  }catch(e){ console.warn("answerIncoming error", e); }
}

async function declineIncoming(){
  if(!incomingConn) return;
  try{ const rt=$("ringtoneAudio"); rt.pause(); rt.currentTime=0; }catch{}
  incomingConn.reject?.(); $("incomingModal").style.display="none";
  await remoteSaveCall({
    user_email: auth.currentUser?.email || "",
    call_type: "incoming",
    from_number: incomingConn?.parameters?.From || "",
    to_number: assignedNumber || "",
    status: "missed",
    created_at: new Date().toISOString(), duration: 0
  });
  incomingConn = null;
}

function hangUp(){ try{ activeConn?.disconnect?.(); device?.disconnectAll?.(); }catch{} stopCallUI(); }
function stopCallUI(){ $("dialpadArea").style.display="flex"; $("activeArea").style.display="none"; $("hangupBtn").style.display="none"; clearWaveform(); stopTimer(); activeConn=null; inCall=false; }

/* mute/hold/speaker (same as your original) */
function toggleMute(){
  if(!activeConn && !localStream) return;
  try{
    if(activeConn?.mute){
      const muted = activeConn.isMuted?.() ?? !!activeConn._muted;
      activeConn.mute(!muted); $("muteBtn").innerText = (!muted) ? "Unmute" : "Mute"; return;
    }
    const s = localStream || activeConn?.mediaStream || activeConn?._mediaStream;
    if(s?.getAudioTracks){ const curr = s.getAudioTracks()[0].enabled; s.getAudioTracks().forEach(t=>t.enabled=!curr); $("muteBtn").innerText = curr ? "Unmute" : "Mute"; }
  }catch{}
}
function toggleHold(){
  if(!activeConn && !localStream) return;
  try{
    const s = localStream || activeConn?.mediaStream || activeConn?._mediaStream;
    if(s?.getAudioTracks){ const curr = s.getAudioTracks()[0].enabled; s.getAudioTracks().forEach(t=>t.enabled=!curr); $("holdBtn").innerText = (!curr) ? "Resume" : "Hold"; }
  }catch{}
}
window._speakerOn = false;
async function toggleSpeaker(){
  try{
    if (!device?.audio) return alert("Speaker toggle not available.");
    const outputsMap = device.audio.availableOutputDevices;
    const speakerCtl  = device.audio.speakerDevices;
    if (!outputsMap || !speakerCtl) return alert("Speaker control not supported.");
    if (!window._speakerOn){
      const allOutputDevices = Array.from(outputsMap.values());
      if (allOutputDevices.length === 0) return alert("No audio output devices found.");
      await speakerCtl.set(allOutputDevices); window._speakerOn = true; $("speakerBtn").innerText = "Speaker Off";
    } else {
      await speakerCtl.clear(); window._speakerOn = false; $("speakerBtn").innerText = "Speaker On";
    }
  }catch{ alert("Speaker toggle not supported on this device/browser."); }
}

/* waveform + timer (same as your original) */
function renderWaveform(){ const w=$("waveWrap"); w.innerHTML=""; for(let i=0;i<6;i++){ const b=document.createElement("div"); b.style.width='6px'; b.style.background='#60a5fa'; b.style.borderRadius='3px'; b.style.height=(8+Math.random()*30)+"px"; b.style.transition='height 120ms'; w.appendChild(b);} (function anim(){ const bars=w.children; for(let i=0;i<bars.length;i++) bars[i].style.height=(8+Math.random()*36)+"px"; wfRaf=requestAnimationFrame(anim); })(); w.style.display="flex"; }
function clearWaveform(){ if(wfRaf) cancelAnimationFrame(wfRaf); $("waveWrap").innerHTML=""; $("waveWrap").style.display="none"; }
function startTimer(){ callStartTs=Date.now(); stopTimer(); timerInterval=setInterval(()=>{ const s=Math.floor((Date.now()-callStartTs)/1000); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); setText("callTimer", mm+":"+ss); },500); }
function stopTimer(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; setText("callTimer","00:00"); } }

/* history */
async function refreshHistory(){
  try{
    const res = await fetch(`${API_BASE}/calls`, { method:"GET", headers: await authHeaders() });
    if(!res.ok){ $("historyList").innerHTML = '<div class="muted">No calls yet</div>'; return; }
    const data = await res.json();
    if(!Array.isArray(data) || data.length===0){ $("historyList").innerHTML = '<div class="muted">No calls yet</div>'; return; }
    renderHistoryItems(data);
  }catch{ $("historyList").innerHTML = '<div class="muted">Error loading history</div>'; }
}
function renderHistoryItems(items){
  const container = $("historyList"); container.innerHTML = "";
  items.forEach(it => {
    const div = document.createElement("div"); div.className="history-item";
    const type = String(it.call_type || it.type || "").toLowerCase();
    let displayNum = ""; if (type === "incoming") displayNum = it.from_number || it.to_number || ""; else if (type === "outgoing") displayNum = it.to_number || it.from_number || ""; else displayNum = it.to_number || it.from_number || "";
    const left = document.createElement("div"); left.style.display="flex"; left.style.flexDirection="column";
    const badge = document.createElement("div"); badge.className="badge"; badge.innerText=(it.call_type || it.type || "UNKNOWN").toUpperCase();
    const main = document.createElement("div"); main.style.fontWeight=700; main.innerText=showE164(displayNum);
    const sub = document.createElement("div"); sub.className="muted"; sub.style.fontSize="12px"; sub.innerText=it.status || "";
    left.appendChild(badge); left.appendChild(main); left.appendChild(sub);
    const right = document.createElement("div"); right.style.textAlign="right"; right.innerHTML = `<div class="muted">${new Date(it.created_at || Date.now()).toLocaleString()}</div><div style="font-weight:700;margin-top:6px">${(it.duration || 0)} s</div>`;
    div.appendChild(left); div.appendChild(right); container.appendChild(div);
  });
}
function startHistoryPolling(){ if(historyPollInterval) clearInterval(historyPollInterval); historyPollInterval=setInterval(refreshHistory,8000); }
function stopHistoryPolling(){ if(historyPollInterval) clearInterval(historyPollInterval); historyPollInterval=null; }

/* UI wiring */
document.addEventListener("click",(e)=>{ const k = e.target.closest("[data-key]"); if(k) $("dialInput").value += k.getAttribute("data-key"); });
$("startCallBtn").addEventListener("click", startCall);
$("hangupBtn").addEventListener("click", hangUp);
$("muteBtn").addEventListener("click", toggleMute);
$("holdBtn").addEventListener("click", toggleHold);
$("answerBtn").addEventListener("click", answerIncoming);
$("declineBtn").addEventListener("click", declineIncoming);
$("logoutBtn").addEventListener("click", performLogout);
$("speakerBtn").addEventListener("click", toggleSpeaker);
$("loginBtn").addEventListener("click", performLogin);
$("sendVerifyBtn").addEventListener("click", sendVerify);
$("loginPassword")?.addEventListener?.("keydown",(e)=>{ if(e.key==='Enter') performLogin(); });

/* after login */
async function postLoginInit(){
  await loadProfile();
  // Mic attempt (may be blocked until gesture)
  try{
    const micOk = await ensureMic();
    if(micOk){ await initTwilioDevice(); }
    else { const gestureInit = async () => { document.removeEventListener("click", gestureInit); const ok = await ensureMic(); if(ok) await initTwilioDevice(); }; document.addEventListener("click", gestureInit); }
  }catch{
    const gestureInit = async () => { document.removeEventListener("click", gestureInit); const ok = await ensureMic(); if(ok) await initTwilioDevice(); };
    document.addEventListener("click", gestureInit);
  }
  await refreshHistory(); startHistoryPolling();
}

/* init */
async function init(){
  auth.onAuthStateChanged(async (u)=>{
    if(u && u.emailVerified){
      hideLoginModal();
      await postLoginInit();
    } else {
      showLoginModal();
    }
  });

  window.addEventListener("beforeunload", (e) => { if (inCall) { e.preventDefault(); e.returnValue = ""; } });
  window.addEventListener("pagehide", () => { try { if (device) device.disconnectAll(); } catch {} });
}
init();
</script>
</body>
</html>
