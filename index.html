<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Call Bridge â€” Tech Talk Titans</title>

  <!-- External SDKs (deferred to avoid race conditions) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.7.1/dist/umd/supabase.min.js" defer></script>
  <script src="https://media.twiliocdn.com/sdk/js/client/v1.13/twilio.min.js" defer></script>

  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --green:#10b981;
      --danger:#ef4444; --shadow: 0 8px 30px rgba(2,6,23,0.08);
    }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Arial}
    html,body{height:100%;margin:0;background:var(--bg)}
    body{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;padding:18px}
    .panel{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);height:calc(100vh - 36px);overflow:auto}
    h2{margin:0 0 8px 0}
    .muted{color:var(--muted);font-size:13px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;color:#fff}
    .btn.call{background:var(--green)} .btn.hang{background:var(--danger)} .btn.gray{background:#374151} .btn.primary{background:var(--accent)}
    input{padding:10px;border:1px solid #e6e9ef;border-radius:10px}
    /* Left */
    #left { display:flex;flex-direction:column; gap:12px; align-items:center }
    #callerNumber { font-weight:700; color:#111827 }
    #dialInput { width:220px }
    .key-row{display:flex;gap:8px;margin-top:8px}
    .key{width:64px;height:64px;border-radius:10px;border:1px solid #e6e9ef;background:#fafbff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    /* Active call area */
    #activeArea{display:none;flex-direction:column;align-items:center;gap:8px}
    #waveWrap{display:flex;gap:6px;align-items:flex-end;height:40px}
    /* Middle */
    #historyList{display:flex;flex-direction:column;gap:10px}
    .history-item{padding:10px;border-radius:10px;border:1px solid #eef2ff;background:#fff;display:flex;justify-content:space-between;align-items:center}
    .badge{padding:6px 8px;border-radius:999px;background:#f1f5f9;font-size:12px;color:#6b7280}
    /* Right */
    .profile-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #f3f4f6}
    /* Incoming modal */
    #incomingModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:9999;align-items:center;justify-content:center}
    .modalCard{background:white;padding:22px;border-radius:12px;width:360px;text-align:center;box-shadow:0 12px 40px rgba(2,6,23,0.12)}
    .modalBtns{display:flex;gap:12px;justify-content:center;margin-top:12px}
    @keyframes pulse {0%{transform:scale(.95);opacity:.8}50%{transform:scale(1.08);opacity:1}100%{transform:scale(.95);opacity:.8}}
    .ringDot{width:72px;height:72px;border-radius:50%;background:var(--green);margin:10px auto;animation:pulse 1.2s infinite}
    /* Auth overlay (mandatory login) */
    #authWrap{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center}
    #authCard{width:360px;background:#fff;border-radius:14px;box-shadow:var(--shadow);padding:22px}
    @media (max-width:900px){body{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <!-- AUTH (mandatory) -->
  <div id="authWrap">
    <div id="authCard">
      <h2 style="margin-bottom:6px">Sign in</h2>
      <div class="muted">Use the email and password assigned to you</div>
      <div style="margin-top:12px">
        <label class="muted">Email</label>
        <input id="email" type="email" placeholder="you@example.com" autocomplete="email" required style="width:100%"/>
      </div>
      <div style="margin-top:12px">
        <label class="muted">Password</label>
        <input id="password" type="password" placeholder="Password" autocomplete="current-password" required style="width:100%"/>
      </div>
      <div style="margin-top:14px;display:flex;gap:10px">
        <button id="loginBtn" class="btn primary" style="flex:1">Login (mandatory)</button>
      </div>
      <div id="authErr" class="muted" style="margin-top:8px;color:#b91c1c"></div>
    </div>
  </div>

  <!-- LEFT: Dialpad / Active Call -->
  <div id="left" class="panel" style="display:none">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
      <h2>Call Bridge</h2>
      <div class="muted">Tech Talk Titans</div>
    </div>

    <div style="text-align:center">
      <div class="muted">Your Virtual Number</div>
      <div id="callerNumber">â€”</div>
    </div>

    <div id="dialpadArea" style="display:flex;flex-direction:column;align-items:center;margin-top:6px">
      <input id="dialInput" placeholder="+1..." />
      <div style="margin-top:12px">
        <div class="key-row">
          <button class="key" data-key="1">1</button>
          <button class="key" data-key="2">2</button>
          <button class="key" data-key="3">3</button>
        </div>
        <div class="key-row">
          <button class="key" data-key="4">4</button>
          <button class="key" data-key="5">5</button>
          <button class="key" data-key="6">6</button>
        </div>
        <div class="key-row">
          <button class="key" data-key="7">7</button>
          <button class="key" data-key="8">8</button>
          <button class="key" data-key="9">9</button>
        </div>
        <div class="key-row">
          <button class="key" data-key=""></button>
          <button class="key" data-key="0">0</button>
          <button class="key" data-key="#">#</button>
        </div>
      </div>

      <div class="controls" style="margin-top:12px">
        <button id="startCallBtn" class="btn call">ðŸ“ž Call</button>
        <button id="hangupBtn" class="btn hang" style="display:none">âœ– Hang Up</button>
      </div>
    </div>

    <div id="activeArea">
      <div id="activeLabel" style="font-weight:700">In Call</div>
      <div id="callTimer" class="muted">00:00</div>
      <div id="waveWrap"></div>
      <div class="controls" style="margin-top:10px">
        <button id="muteBtn" class="btn gray">Mute</button>
        <button id="holdBtn" class="btn gray">Hold</button>
      </div>
    </div>
  </div>

  <!-- MIDDLE: Call History -->
  <div id="middle" class="panel" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Call History</h2>
      <div class="muted">Latest</div>
    </div>
    <div id="historyList" style="margin-top:12px">
      <div class="muted">Loading call history...</div>
    </div>
  </div>

  <!-- RIGHT: Profile -->
  <div id="right" class="panel" style="display:none">
    <h2>My Profile</h2>
    <div class="profile-row"><div class="muted">Email</div><div id="pEmail">â€”</div></div>
    <div class="profile-row"><div class="muted">Display Name</div><div id="pName">â€”</div></div>
    <div class="profile-row"><div class="muted">Assigned Number</div><div id="pNumber">â€”</div></div>
    <div class="profile-row"><div class="muted">Status</div><div id="pStatus">â€”</div></div>
    <div class="profile-row"><div class="muted">Valid Until</div><div id="pExpiry">â€”</div></div>
    <div style="margin-top:14px"><button id="logoutBtn" class="btn hang" style="width:100%">Logout</button></div>
  </div>

  <!-- Incoming Call Modal -->
  <div id="incomingModal" style="display:none;align-items:center;justify-content:center">
    <div class="modalCard">
      <div style="font-weight:700;font-size:18px">Incoming Call</div>
      <div id="incomingFrom" class="muted" style="margin-top:6px">From: â€”</div>
      <div class="ringDot"></div>
      <div class="modalBtns">
        <button id="answerBtn" class="btn call">Answer</button>
        <button id="declineBtn" class="btn hang">Decline</button>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG: point to your Python backend on Render ===== */
const API_BASE = "https://callbridge.onrender.com";

/* ===== Global state ===== */
let session = { token:null, user:null };      // from /login
let device = null, activeConn = null, incomingConn = null;
let callStartTs = 0, timerInterval = null, wfRaf = null;

/* ===== Small DOM helpers ===== */
function $(id){ return document.getElementById(id); }
function setText(id,txt){ const el=$(id); if(el) el.innerText = txt; }

/* ===== UI: keypad click ===== */
document.addEventListener("click", function(e){
  const k = e.target.closest("[data-key]");
  if (!k) return;
  const v = k.getAttribute("data-key") || "";
  const input = $("dialInput");
  if (input) input.value = (input.value || "") + v;
});

/* ===== Login flow (mandatory) ===== */
$("loginBtn").addEventListener("click", login);
$("password").addEventListener("keydown", function(e){ if(e.key==="Enter") login(); });

async function login(){
  const email = $("email").value.trim();
  const password = $("password").value;
  $("authErr").innerText = "";
  if(!email || !password){ $("authErr").innerText = "Enter email and password."; return; }

  try{
    const r = await fetch(API_BASE + "/login", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ email, password })
    });
    const data = await r.json();
    if(!r.ok) throw new Error(data && data.error ? data.error : "Login failed");

    session.token = data.token || null;
    session.user  = data.user || { email: email };
    await loadProfile(email);   // fills assigned number, etc.
    showApp();
    await prepareAudio();
    await initTwilioDevice();
    await refreshHistory();
  }catch(err){
    console.error(err);
    $("authErr").innerText = "Login failed: " + err.message;
  }
}

function showApp(){
  $("authWrap").style.display = "none";
  $("left").style.display = "";
  $("middle").style.display = "";
  $("right").style.display = "";
}

/* ===== Profile ===== */
async function loadProfile(email){
  try{
    const r = await fetch(API_BASE + "/profile", {
      method: "POST",
      headers: { "Content-Type":"application/json", ...(session.token?{Authorization:"Bearer "+session.token}:{}) },
      body: JSON.stringify({ email: email })
    });
    if(r.ok){
      const p = await r.json();
      const u = session.user || {};
      u.email = p.email || email;
      u.display_name = p.display_name || p.displayName || u.display_name;
      u.assigned_number = p.assigned_number || p.assignedNumber || u.assigned_number;
      u.expiry_date = p.expiry_date || p.expiryDate || u.expiry_date;
      u.status = p.status || u.status || "active";
      session.user = u;

      setText("pEmail", u.email || "â€”");
      setText("pName",  u.display_name || "â€”");
      setText("pNumber", u.assigned_number || "â€”");
      setText("pStatus", u.status || "â€”");
      setText("pExpiry", u.expiry_date || "â€”");
      setText("callerNumber", u.assigned_number || "â€”");
    }
  }catch(e){ console.warn("profile load error", e); }
}

/* ===== History ===== */
async function refreshHistory(){
  try{
    const email = (session.user && session.user.email) || "";
    const url = API_BASE + "/calls" + (email ? ("?email="+encodeURIComponent(email)) : "");
    const r = await fetch(url, { headers: session.token?{Authorization:"Bearer "+session.token}:{}} );
    if(!r.ok){ $("historyList").innerHTML = '<div class="muted">No calls yet</div>'; return; }
    const arr = await r.json();
    renderHistory(arr || []);
  }catch(e){
    console.warn(e);
    $("historyList").innerHTML = '<div class="muted">Error loading history</div>';
  }
}
function renderHistory(items){
  const c = $("historyList");
  c.innerHTML = "";
  if(!items.length){ c.innerHTML = '<div class="muted">No calls yet</div>'; return; }
  items.forEach(function(it){
    const row = document.createElement("div"); row.className = "history-item";
    const left = document.createElement("div"); left.style.display="flex"; left.style.flexDirection="column";
    const badge = document.createElement("div"); badge.className="badge"; badge.innerText = (it.call_type || it.type || "UNKNOWN").toUpperCase();
    const main = document.createElement("div"); main.style.fontWeight = "700"; main.innerText = String(it.phone_number || it.other_number || it.to_number || it.from_number || "â€”");
    const sub  = document.createElement("div"); sub.className="muted"; sub.style.fontSize="12px"; sub.innerText = it.status || "";
    left.appendChild(badge); left.appendChild(main); left.appendChild(sub);

    const right = document.createElement("div"); right.style.textAlign="right";
    const ts = new Date(it.created_at || it.started_at || Date.now()).toLocaleString();
    right.innerHTML = '<div class="muted">'+ts+'</div><div style="font-weight:700;margin-top:6px">'+String(it.duration || 0)+' s</div>';

    row.appendChild(left); row.appendChild(right);
    c.appendChild(row);
  });
}

/* ===== Twilio ===== */
async function prepareAudio(){
  try{
    if(!navigator.mediaDevices || typeof navigator.mediaDevices.getUserMedia!=="function"){
      throw new Error("Microphone API unavailable");
    }
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    try{ (stream.getTracks()||[]).forEach(function(t){ t.stop(); }); }catch(_){}
    console.log("Audio prepared and getUserMedia obtained");
  }catch(e){
    console.error("Mic prepare failed:", e);
  }
}

async function fetchTwilioToken(){
  const email = (session.user && session.user.email) || "";
  const r = await fetch(API_BASE + "/twilio-token", {
    method: "POST",
    headers: { "Content-Type":"application/json", ...(session.token?{Authorization:"Bearer "+session.token}:{}) },
    body: JSON.stringify({ email: email })
  });
  const data = await r.json();
  if(!r.ok || !data || !data.token) throw new Error((data && data.error) || "No token");
  const cid = data.callerId || (session.user && session.user.assigned_number) || "";
  if(cid){ setText("callerNumber", cid); }
  return data.token;
}

async function initTwilioDevice(){
  try{
    // wait for SDK to be present
    if(!(window.Twilio && window.Twilio.Device)){
      await new Promise(function(res){
        const iv = setInterval(function(){
          if(window.Twilio && window.Twilio.Device){ clearInterval(iv); res(); }
        }, 80);
      });
    }
    const token = await fetchTwilioToken();

    if(typeof Twilio.Device.setup === "function"){
      Twilio.Device.setup(token);
      device = Twilio.Device;
    }else{
      try{
        device = new Twilio.Device(token, { debug:true });
      }catch(err){
        if(typeof Twilio.Device.setup === "function"){
          Twilio.Device.setup(token);
          device = Twilio.Device;
        }else{
          throw err;
        }
      }
    }

    // events
    if(device && typeof device.on === "function"){
      device.on("ready", function(){ console.log("Twilio ready"); });
      device.on("error", function(err){ console.error("Twilio error:", err); });
      device.on("connect", onDeviceConnect);
      device.on("disconnect", onDeviceDisconnect);
      device.on("incoming", onDeviceIncoming);
    }
  }catch(e){
    console.error("initTwilioDevice error", e);
  }
}

function onDeviceConnect(conn){
  try{
    activeConn = conn;
    $("dialpadArea").style.display = "none";
    $("activeArea").style.display = "flex";
    $("hangupBtn").style.display = "inline-block";
    setText("activeLabel", (conn.parameters && (conn.parameters.To || conn.parameters.From)) || "In Call");
    startTimer(); renderWaveform();

    conn.on("disconnect", async function(){
      const dur = Math.max(0, Math.floor((Date.now()-callStartTs)/1000));
      await safeSaveCall({
        user_email: (session.user && session.user.email)||"",
        call_type: conn.parameters && conn.parameters.To ? "outgoing" : "incoming",
        phone_number: (conn.parameters && (conn.parameters.To || conn.parameters.From)) || "",
        status: "completed",
        created_at: new Date().toISOString(),
        duration: dur
      });
      stopCallUI();
      refreshHistory();
    });

    conn.on("error", function(err){
      console.error("connection error", err);
      stopCallUI();
    });
  }catch(e){ console.warn("onDeviceConnect error", e); }
}

function onDeviceDisconnect(){ activeConn = null; stopCallUI(); }
function onDeviceIncoming(call){
  incomingConn = call;
  setText("incomingFrom", "From: " + (call.parameters && call.parameters.From ? call.parameters.From : "Unknown"));
  $("incomingModal").style.display = "flex";
}

$("answerBtn").addEventListener("click", async function(){
  if(!incomingConn) return;
  try{ if(typeof incomingConn.accept==="function") incomingConn.accept(); }catch(_){}
  $("incomingModal").style.display = "none";
  await safeSaveCall({
    user_email: (session.user && session.user.email)||"",
    call_type: "incoming",
    phone_number: (incomingConn.parameters && incomingConn.parameters.From) || "",
    status: "answered",
    created_at: new Date().toISOString()
  });
});
$("declineBtn").addEventListener("click", async function(){
  if(!incomingConn) return;
  try{ if(typeof incomingConn.reject==="function") incomingConn.reject(); }catch(_){}
  $("incomingModal").style.display = "none";
  await safeSaveCall({
    user_email: (session.user && session.user.email)||"",
    call_type: "incoming",
    phone_number: (incomingConn.parameters && incomingConn.parameters.From) || "",
    status: "missed",
    created_at: new Date().toISOString(),
    duration: 0
  });
  incomingConn = null;
});

/* ===== Outgoing / controls ===== */
$("startCallBtn").addEventListener("click", startCall);
$("hangupBtn").addEventListener("click", hangUp);
$("muteBtn").addEventListener("click", toggleMute);
$("holdBtn").addEventListener("click", toggleHold);
$("logoutBtn").addEventListener("click", function(){
  session = { token:null, user:null };
  location.reload();
});

async function startCall(){
  const number = ($("dialInput").value || "").trim();
  if(!number) { alert("Enter a number to call."); return; }
  if(!device) { alert("Device not ready."); return; }
  try{
    await safeSaveCall({
      user_email: (session.user && session.user.email)||"",
      call_type: "outgoing",
      phone_number: number,
      status: "initiated",
      created_at: new Date().toISOString()
    });

    if(typeof device.connect === "function"){
      device.connect({ To: number });
    }else if(window.Twilio && window.Twilio.Device && typeof Twilio.Device.connect === "function"){
      Twilio.Device.connect({ To: number });
    }else{
      alert("Unable to place call (connect API not available).");
    }
  }catch(e){ console.error(e); alert("Failed to start call."); }
}

function hangUp(){
  try{
    if(device && typeof device.disconnectAll==="function") device.disconnectAll();
    else if(window.Twilio && window.Twilio.Device && typeof Twilio.Device.disconnectAll==="function") Twilio.Device.disconnectAll();
  }catch(e){ console.warn("hangUp error", e); }
  stopCallUI();
}

function toggleMute(){
  if(!activeConn) return;
  try{
    if(typeof activeConn.mute==="function"){
      const currentlyMuted = typeof activeConn.isMuted==="function" ? activeConn.isMuted() : !!activeConn._muted;
      activeConn.mute(!currentlyMuted);
      $("muteBtn").innerText = (!currentlyMuted) ? "Unmute" : "Mute";
    }
  }catch(e){ console.warn(e); }
}
function toggleHold(){
  if(!activeConn) return;
  try{
    const s = activeConn.mediaStream || activeConn._mediaStream;
    if(s && s.getAudioTracks){
      s.getAudioTracks().forEach(function(t){ t.enabled = !t.enabled; });
      $("holdBtn").innerText = s.getAudioTracks()[0].enabled ? "Hold" : "Resume";
    }
  }catch(e){ console.warn(e); }
}

function stopCallUI(){
  $("dialpadArea").style.display = "flex";
  $("activeArea").style.display = "none";
  $("hangupBtn").style.display = "none";
  clearWaveform();
  stopTimer();
}

/* ===== Save call to backend ===== */
async function safeSaveCall(payload){
  try{
    await fetch(API_BASE + "/save-call", {
      method: "POST",
      headers: { "Content-Type":"application/json", ...(session.token?{Authorization:"Bearer "+session.token}:{}) },
      body: JSON.stringify(payload)
    });
  }catch(e){ console.warn("save-call failed", e); }
}

/* ===== Timer + Waveform ===== */
function startTimer(){
  callStartTs = Date.now();
  stopTimer();
  timerInterval = setInterval(function(){
    const s = Math.floor((Date.now() - callStartTs)/1000);
    const mm = String(Math.floor(s/60)).padStart(2,"0");
    const ss = String(s%60).padStart(2,"0");
    setText("callTimer", mm + ":" + ss);
  }, 500);
}
function stopTimer(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval = null; setText("callTimer","00:00"); }
}
function renderWaveform(){
  const wrap = $("waveWrap"); wrap.innerHTML = "";
  for(var i=0;i<6;i++){
    const b = document.createElement("div");
    b.style.width = "6px";
    b.style.background = "#60a5fa";
    b.style.borderRadius = "3px";
    b.style.height = (8 + Math.random()*30) + "px";
    b.style.transition = "height 120ms";
    wrap.appendChild(b);
  }
  (function animate(){
    const bars = wrap.children;
    for(var i=0;i<bars.length;i++){
      bars[i].style.height = (8 + Math.random()*36) + "px";
    }
    wfRaf = requestAnimationFrame(animate);
  })();
  wrap.style.display = "flex";
}
function clearWaveform(){ if(wfRaf) cancelAnimationFrame(wfRaf); $("waveWrap").innerHTML=""; $("waveWrap").style.display="none"; }

/* ===== Startup: keep app hidden until login ===== */
window.addEventListener("DOMContentLoaded", function(){
  $("authWrap").style.display = "flex";
  $("left").style.display = "none";
  $("middle").style.display = "none";
  $("right").style.display = "none";
});
</script>
</body>
</html>
