<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CallBridge</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }
    header {
      background: #111827;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 2rem auto;
      background: #fff;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .dialpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: .5rem;
    }
    .dialpad button {
      font-size: 1.5rem;
      padding: 1rem;
      border-radius: .5rem;
      border: 1px solid #ccc;
      background: #f3f4f6;
      cursor: pointer;
    }
    .hidden { display: none; }
    #status { margin: .5rem 0; color: #059669; }
  </style>
</head>
<body>
  <header><h1>CallBridge</h1></header>

  <div class="container" id="loginBox">
    <h2>Login</h2>
    <input id="email" placeholder="Email" type="email" style="width:100%;padding:.5rem;margin-bottom:.5rem">
    <input id="password" placeholder="Password" type="password" style="width:100%;padding:.5rem;margin-bottom:.5rem">
    <button onclick="performLogin()" style="width:100%;padding:.75rem;background:#2563eb;color:#fff;border:none;border-radius:.5rem;">Login</button>
  </div>

  <div class="container hidden" id="appBox">
    <h2>Welcome, <span id="displayName">User</span></h2>
    <p>Email: <span id="pEmail">—</span></p>
    <p>Number: <span id="pNumber">—</span></p>
    <p>Expires: <span id="pExpiry">—</span></p>
    <p id="status">Device not ready</p>

    <input id="phoneNumber" placeholder="Enter number" style="width:100%;padding:.5rem;margin-bottom:.5rem">
    <div class="dialpad">
      <button onclick="appendDigit('1')">1</button>
      <button onclick="appendDigit('2')">2</button>
      <button onclick="appendDigit('3')">3</button>
      <button onclick="appendDigit('4')">4</button>
      <button onclick="appendDigit('5')">5</button>
      <button onclick="appendDigit('6')">6</button>
      <button onclick="appendDigit('7')">7</button>
      <button onclick="appendDigit('8')">8</button>
      <button onclick="appendDigit('9')">9</button>
      <button onclick="appendDigit('*')">*</button>
      <button onclick="appendDigit('0')">0</button>
      <button onclick="appendDigit('#')">#</button>
    </div>
    <button id="callBtn" onclick="makeCall()" style="width:100%;padding:.75rem;background:#16a34a;color:#fff;border:none;border-radius:.5rem;margin-top:1rem;">Call</button>
    <button onclick="hangup()" style="width:100%;padding:.75rem;background:#dc2626;color:#fff;border:none;border-radius:.5rem;margin-top:.5rem;">Hang Up</button>
  </div>

  <script src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>
  <script>
    const API_BASE = "https://callbridge.onrender.com"; // your backend URL
    let currentUser = null;
    let device = null;

    async function performLogin() {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      try {
        const res = await fetch(API_BASE + "/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });
        if (!res.ok) throw new Error("Invalid credentials");

        const data = await res.json();
        console.log("LOGIN SUCCESS:", data);

        localStorage.setItem("authToken", data.token);
        localStorage.setItem("currentUser", JSON.stringify(data.user));

        currentUser = data.user;
        postLoginInit();
      } catch (e) {
        console.error("Login error:", e);
        alert("Login failed: " + e.message);
      }
    }

    function appendDigit(d) {
      const input = document.getElementById("phoneNumber");
      input.value += d;
    }

    function showLoginModal() {
      document.getElementById("loginBox").classList.remove("hidden");
      document.getElementById("appBox").classList.add("hidden");
    }

    function showApp() {
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("appBox").classList.remove("hidden");
    }

    async function postLoginInit() {
      if (!currentUser) return;
      showApp();

      document.getElementById("displayName").innerText = currentUser.display_name;
      document.getElementById("pEmail").innerText = currentUser.email;
      document.getElementById("pNumber").innerText = currentUser.assigned_number;
      document.getElementById("pExpiry").innerText = currentUser.expiry_date;

      await initTwilioDevice();
    }

    async function initTwilioDevice() {
      try {
        const res = await fetch(API_BASE + "/token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ identity: currentUser.email })
        });
        const data = await res.json();

        if (!data.token) throw new Error("No token returned");

        device = new Twilio.Device(data.token, {
          codecPreferences: ["opus", "pcmu"],
          fakeLocalDTMF: true,
          enableRingingState: true
        });

        device.on("ready", () => {
          document.getElementById("status").innerText = "Device ready";
        });
        device.on("error", (err) => {
          console.error("Twilio Device error:", err);
          document.getElementById("status").innerText = "Device error: " + err.message;
        });
        device.on("incoming", (conn) => {
          if (confirm("Incoming call from " + conn.parameters.From)) {
            conn.accept();
          } else {
            conn.reject();
          }
        });

      } catch (err) {
        console.error("initTwilioDevice error:", err);
        document.getElementById("status").innerText = "Twilio init failed";
      }
    }

    function makeCall() {
      if (!device) {
        alert("Device not ready");
        return;
      }
      const num = document.getElementById("phoneNumber").value;
      if (!num) return alert("Enter a number");
      const conn = device.connect({ To: num });
      document.getElementById("status").innerText = "Calling " + num;
    }

    function hangup() {
      if (device) device.disconnectAll();
      document.getElementById("status").innerText = "Call ended";
    }

    async function ensureMic() {
      try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log("✅ Microphone permission granted");
      } catch (err) {
        alert("Microphone access denied");
        throw err;
      }
    }

    /* ---------- app init ---------- */
    async function init() {
      try {
        await ensureMic();
        const token = localStorage.getItem("authToken");
        const savedUser = JSON.parse(localStorage.getItem("currentUser") || "{}");

        if (token && savedUser && savedUser.email) {
          console.log("Auto-login detected:", savedUser);
          currentUser = savedUser;
          await postLoginInit();
          return;
        }

        console.warn("No saved user or token, showing login");
        showLoginModal();
      } catch (err) {
        console.error("App init error:", err);
        showLoginModal();
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
