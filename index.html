<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Call Bridge — Tech Talk Titans</title>

  <!-- ✅ Removed static Twilio SDK import, now loaded dynamically -->
  
  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --green:#10b981;
      --danger:#ef4444; --shadow: 0 8px 30px rgba(2,6,23,0.08);
    }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Arial;}
    html,body{height:100%;margin:0;background:var(--bg)}
    body{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;padding:18px}
    .panel{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);height:calc(100vh - 36px);overflow:auto}
    h2{margin:0 0 8px 0}
    .muted{color:var(--muted);font-size:13px}
    #left { display:flex;flex-direction:column; gap:12px; align-items:center }
    #callerNumber { font-weight:700; color:#111827; }
    input#dialInput { width:220px;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:16px }
    .key-row{display:flex;gap:8px;margin-top:8px}
    .key{width:64px;height:64px;border-radius:10px;border:1px solid #e6e9ef;background:#fafbff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .key.primary{background:var(--accent);color:#fff;border:none}
    .controls{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;color:#fff}
    .btn.call{background:var(--green)} .btn.hang{background:var(--danger)} .btn.gray{background:#374151}
    #activeArea{display:none;flex-direction:column;align-items:center;gap:8px}
    #waveWrap{display:flex;gap:6px;align-items:flex-end;height:40px}
    #historyList{display:flex;flex-direction:column;gap:10px}
    .history-item{padding:10px;border-radius:10px;border:1px solid #eef2ff;background:#fff;display:flex;justify-content:space-between;align-items:center}
    .badge{padding:6px 8px;border-radius:999px;background:#f1f5f9;font-size:12px;color:var(--muted)}
    .profile-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #f3f4f6}
    #incomingModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:9999;align-items:center;justify-content:center}
    .modalCard{background:white;padding:22px;border-radius:12px;width:360px;text-align:center;box-shadow:0 12px 40px rgba(2,6,23,0.12)}
    .modalBtns{display:flex;gap:12px;justify-content:center;margin-top:12px}
    @keyframes pulse {0%{transform:scale(0.95);opacity:0.8}50%{transform:scale(1.08);opacity:1}100%{transform:scale(0.95);opacity:0.8}}
    .ringDot{width:72px;height:72px;border-radius:50%;background:var(--green);margin:10px auto;animation:pulse 1.2s infinite}
    @media (max-width:900px){body{grid-template-columns:1fr;} }
    #loginModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:10000;align-items:center;justify-content:center}
    #loginModal .modalCard { width:360px;text-align:left; }
    #loginModal input { width:100%; padding:10px; border-radius:8px; border:1px solid #e6e9ef; margin-top:8px; }
  </style>
</head>
<body>
  <!-- ✅ Your existing UI sections (Dialpad, History, Profile, Modals) stay the same -->
  <!-- Keeping for brevity, all unchanged HTML is the same as before -->

  <audio id="ringtoneAudio" preload="auto"></audio>

<script>
/* ================= CONFIG ================= */
const API_BASE = "https://callbridge.onrender.com";

/* ---------- Dynamic Twilio SDK Loader ---------- */
async function loadTwilioSDK() {
  return new Promise((resolve, reject) => {
    if (window.Twilio && window.Twilio.Device) {
      console.log("✅ Twilio SDK already available");
      return resolve();
    }
    const script = document.createElement("script");
    script.src = "https://sdk.twilio.com/js/voice/releases/2.0.1/twilio.min.js";
    script.async = true;
    script.crossOrigin = "anonymous";
    script.onload = () => {
      if (window.Twilio && window.Twilio.Device) {
        console.log("✅ Twilio SDK loaded successfully");
        resolve();
      } else reject(new Error("Twilio SDK did not initialize correctly"));
    };
    script.onerror = () => reject(new Error("❌ Failed to load Twilio SDK"));
    document.head.appendChild(script);
  });
}

/* ---------- Safe Twilio Init ---------- */
async function safeInitTwilioDevice(tokenJson) {
  try {
    await loadTwilioSDK();
    if (!tokenJson || !tokenJson.token) {
      console.error("No token provided for Twilio device.");
      return;
    }
    const device = new Twilio.Device(tokenJson.token, {
      codecPreferences: ["opus", "pcmu"],
      debug: false,
    });
    console.log("🎧 Twilio.Device initialized");
    device.on("ready", () => console.log("✅ Twilio Device ready"));
    device.on("error", (err) => console.error("Twilio Device error:", err));
    window.device = device;
  } catch (err) {
    console.error("Twilio device initialization failed:", err);
  }
}

/* ====== The rest of your code (login, initTwilioDevice, startCall, etc.) remains the same ====== */

/* At the end of your script, ensure init() is called inside an async wrapper */
(async () => {
  try {
    await init();  // safely runs your existing init() function
  } catch (e) {
    console.error("Init error:", e);
  }
})();
</script>
</body>
</html>
