<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Call Bridge — Tech Talk Titans</title>
  <script src="https://media.twiliocdn.com/sdk/js/client/v1.13/twilio.min.js"></script>
  <style>
    :root {
      --bg:#f4f6f9;--card:#ffffff;--muted:#6b7280;--accent:#2563eb;--green:#10b981;--danger:#ef4444;--shadow:0 8px 30px rgba(2,6,23,0.08);
    }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Arial;}
    html,body{height:100%;margin:0;background:var(--bg);}
    body{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;padding:18px;}
    .panel{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);height:calc(100vh - 36px);overflow:auto;}
    h2{margin:0 0 8px 0;}
    .muted{color:var(--muted);font-size:13px;}
    #left{display:flex;flex-direction:column;gap:12px;align-items:center;}
    #callerNumber{font-weight:700;color:#111827;}
    input#dialInput{width:220px;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:16px;}
    .key-row{display:flex;gap:8px;margin-top:8px;}
    .key{width:64px;height:64px;border-radius:10px;border:1px solid #e6e9ef;background:#fafbff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .key.primary{background:var(--accent);color:#fff;border:none;}
    .controls{display:flex;gap:10px;margin-top:12px;}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;color:#fff;}
    .btn.call{background:var(--green);}
    .btn.hang{background:var(--danger);}
    .btn.gray{background:#374151;}
    #activeArea{display:none;flex-direction:column;align-items:center;gap:8px;}
    #waveWrap{display:flex;gap:6px;align-items:flex-end;height:40px;}
    #historyList{display:flex;flex-direction:column;gap:10px;}
    .history-item{padding:10px;border-radius:10px;border:1px solid #eef2ff;background:#fff;display:flex;justify-content:space-between;align-items:center;}
    .badge{padding:6px 8px;border-radius:999px;background:#f1f5f9;font-size:12px;color:var(--muted);}
    .profile-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #f3f4f6;}
    #incomingModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:9999;align-items:center;justify-content:center;}
    .modalCard{background:white;padding:22px;border-radius:12px;width:360px;text-align:center;box-shadow:0 12px 40px rgba(2,6,23,0.12);}
    .modalBtns{display:flex;gap:12px;justify-content:center;margin-top:12px;}
    @keyframes pulse{0%{transform:scale(0.95);opacity:0.8}50%{transform:scale(1.08);opacity:1}100%{transform:scale(0.95);opacity:0.8}}
    .ringDot{width:72px;height:72px;border-radius:50%;background:var(--green);margin:10px auto;animation:pulse 1.2s infinite;}
    @media (max-width:900px){body{grid-template-columns:1fr;}}
    #loginModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:10000;align-items:center;justify-content:center;}
    #loginModal .modalCard{width:360px;text-align:left;}
    #loginModal input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-top:8px;}
  </style>
</head>
<body>

  <!-- Left, Middle, Right Panels (unchanged from your version) -->
  <!-- [omitted here for brevity, keep identical to your current HTML panels up to </div> before <script>] -->

<script>
const API_BASE = "https://callbridge.onrender.com";
const $ = id => document.getElementById(id);
const setText = (id, txt) => { const el = $(id); if (el) el.innerText = txt; };

let device=null,activeConn=null,incomingConn=null,currentUser=null,assignedNumber="",callStartTs=0,timerInterval=null,wfRaf=null,historyPollInterval=null;
const SAVE_ENDPOINTS=[API_BASE+"/save-call"];

function getAuthToken(){return localStorage.getItem("auth_token");}
function setAuthToken(t){t?localStorage.setItem("auth_token",t):localStorage.removeItem("auth_token");}
function authHeaders(){const t=getAuthToken();return t?{"Authorization":"Bearer "+t}:{ };}

function showLoginModal(){$("loginModal").style.display="flex";}
function hideLoginModal(){$("loginModal").style.display="none";}

async function performLogin(){
  const email=$("loginEmail").value.trim(),password=$("loginPassword").value;
  $("loginError").style.display="none";
  if(!email||!password){$("loginError").innerText="Enter email and password."; $("loginError").style.display="block"; return;}
  try{
    const res=await fetch(API_BASE+"/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,password})});
    if(!res.ok){$("loginError").innerText="Invalid login."; $("loginError").style.display="block"; return;}
    const data=await res.json();
    if(!data.token){$("loginError").innerText="Invalid login response."; $("loginError").style.display="block"; return;}
    setAuthToken(data.token);
    localStorage.setItem("user",JSON.stringify(data.user));
    currentUser=data.user;
    hideLoginModal();
    await postLoginInit();
  }catch(e){console.error(e);$("loginError").innerText="Network error."; $("loginError").style.display="block";}
}

async function performLogout(){
  try{await fetch(API_BASE+"/logout",{method:"POST",headers:Object.assign({"Content-Type":"application/json"},authHeaders())});}catch(_){}
  setAuthToken(null); currentUser=null;
  if(historyPollInterval){clearInterval(historyPollInterval);}
  showLoginModal();
}

async function loadProfile(){
  try{
    const savedUser=JSON.parse(localStorage.getItem("user")||"{}");
    if(!savedUser.email){console.warn("No user in storage");return;}
    const res=await fetch(API_BASE+"/profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:savedUser.email})});
    if(!res.ok){console.warn("Profile fetch failed",res.status);return;}
    const p=await res.json();
    currentUser=p;
    setText("pEmail",p.email||"—");
    setText("pNumber",p.assigned_number||"—");
    setText("pStatus",p.role||"Active");
    setText("pExpiry",p.expiry_date?new Date(p.expiry_date).toLocaleDateString():"—");
    assignedNumber=p.assigned_number||"—";
    setText("callerNumber",assignedNumber);
  }catch(e){console.error("loadProfile error",e);}
}

/* Twilio + call functions are same — keep your originals unchanged here */

async function postLoginInit(){
  await loadProfile();
  await initTwilioDevice();
  await refreshHistory();
  startHistoryPolling();
}

/* --- FIXED init() --- */
async function init(){
  try{
    await ensureMic();
    const token=getAuthToken();
    if(!token){showLoginModal();return;}
    const savedUser=JSON.parse(localStorage.getItem("user")||"{}");
    if(!savedUser.email){showLoginModal();return;}
    const res=await fetch(API_BASE+"/profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:savedUser.email})});
    if(!res.ok){setAuthToken(null);showLoginModal();return;}
    const profile=await res.json();
    currentUser=profile;
    await postLoginInit();
  }catch(e){
    console.error("init error",e);
    showLoginModal();
  }
}

/* --- Wire up buttons and events --- */
document.addEventListener("DOMContentLoaded",init);
$("loginBtn").addEventListener("click",performLogin);
$("loginPassword").addEventListener("keydown",e=>{if(e.key==="Enter")performLogin();});
$("logoutBtn").addEventListener("click",performLogout);
</script>
</body>
</html>
