<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Call Bridge — Tech Talk Titans</title>

  <!-- Twilio Voice SDK v2 (blocking load — required so window.Twilio is available before script runs) -->
  <script src="https://media.twiliocdn.com/sdk/js/voice/v2/twilio.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --green:#10b981;
      --danger:#ef4444; --shadow: 0 8px 30px rgba(2,6,23,0.08);
    }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Arial;}
    html,body{height:100%;margin:0;background:var(--bg)}
    body{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;padding:18px}

    .panel{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);height:calc(100vh - 36px);overflow:auto}
    h2{margin:0 0 8px 0}
    .muted{color:var(--muted);font-size:13px}

    /* Left - Dialpad / Active Call */
    #left { display:flex;flex-direction:column; gap:12px; align-items:center }
    #callerNumber { font-weight:700; color:#111827; }
    input#dialInput { width:220px;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:16px }

    .key-row{display:flex;gap:8px;margin-top:8px}
    .key{width:64px;height:64px;border-radius:10px;border:1px solid #e6e9ef;background:#fafbff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .key.primary{background:var(--accent);color:#fff;border:none}

    .controls{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;color:#fff}
    .btn.call{background:var(--green)} .btn.hang{background:var(--danger)} .btn.gray{background:#374151}

    /* active call controls */
    #activeArea{display:none;flex-direction:column;align-items:center;gap:8px}
    #waveWrap{display:flex;gap:6px;align-items:flex-end;height:40px}

    /* middle - history */
    #historyList{display:flex;flex-direction:column;gap:10px}
    .history-item{padding:10px;border-radius:10px;border:1px solid #eef2ff;background:#fff;display:flex;justify-content:space-between;align-items:center}
    .badge{padding:6px 8px;border-radius:999px;background:#f1f5f9;font-size:12px;color:var(--muted)}

    /* right - profile */
    .profile-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #f3f4f6}

    /* incoming modal */
    #incomingModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:9999;align-items:center;justify-content:center}
    .modalCard{background:white;padding:22px;border-radius:12px;width:360px;text-align:center;box-shadow:0 12px 40px rgba(2,6,23,0.12)}
    .modalBtns{display:flex;gap:12px;justify-content:center;margin-top:12px}

    @keyframes pulse {
      0%{transform:scale(0.95);opacity:0.8}50%{transform:scale(1.08);opacity:1}100%{transform:scale(0.95);opacity:0.8}
    }

    .ringDot{width:72px;height:72px;border-radius:50%;background:var(--green);margin:10px auto;animation:pulse 1.2s infinite}
    @media (max-width:900px){body{grid-template-columns:1fr;} }

    /* Login modal overrides (keeps the same card style) */
    #loginModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:10000;align-items:center;justify-content:center}
    #loginModal .modalCard { width:360px;text-align:left; }
    #loginModal input { width:100%; padding:10px; border-radius:8px; border:1px solid #e6e9ef; margin-top:8px; }
  </style>
</head>
<body>

  <!-- LEFT: Dialpad / Active Call -->
  <div id="left" class="panel">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
      <h2>Call Bridge</h2>
      <div class="muted">Tech Talk Titans</div>
    </div>

    <div style="text-align:center">
      <div class="muted">Your Virtual Number</div>
      <div id="callerNumber">Loading...</div>
    </div>

    <!-- Dialpad -->
    <div id="dialpadArea" style="display:flex;flex-direction:column;align-items:center;margin-top:6px">
      <input id="dialInput" placeholder="+1..." />
      <div style="margin-top:12px">
        <div class="key-row">
          <button class="key" data-key="1">1</button>
          <button class="key" data-key="2">2</button>
          <button class="key" data-key="3">3</button>
        </div>
        <div class="key-row">
          <button class="key" data-key="4">4</button>
          <button class="key" data-key="5">5</button>
          <button class="key" data-key="6">6</button>
        </div>
        <div class="key-row">
          <button class="key" data-key="7">7</button>
          <button class="key" data-key="8">8</button>
          <button class="key" data-key="9">9</button>
        </div>
        <div class="key-row">
          <button class="key" data-key=""></button>
          <button class="key" data-key="0">0</button>
          <button class="key" data-key="#">#</button>
        </div>
      </div>

      <div class="controls" style="margin-top:12px">
        <button id="startCallBtn" class="btn call">📞 Call</button>
        <button id="hangupBtn" class="btn hang" style="display:none">✖ Hangup</button>
      </div>
    </div>

    <!-- Active call area -->
    <div id="activeArea">
      <div id="activeLabel" style="font-weight:700">In Call</div>
      <div id="callTimer" class="muted">00:00</div>
      <div id="waveWrap"></div>
      <div class="controls" style="margin-top:10px">
        <button id="muteBtn" class="btn gray">Mute</button>
        <button id="holdBtn" class="btn gray">Hold</button>
      </div>
    </div>
  </div>

  <!-- MIDDLE: Call History -->
  <div id="middle" class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Call History</h2>
      <div class="muted">Latest</div>
    </div>

    <div id="historyList" style="margin-top:12px">
      <div class="muted">Loading call history...</div>
    </div>
  </div>

  <!-- RIGHT: Profile -->
  <div id="right" class="panel">
    <h2>My Profile</h2>
    <div class="profile-row"><div class="muted">Email</div><div id="pEmail">Loading...</div></div>
    <div class="profile-row"><div class="muted">Assigned Number</div><div id="pNumber">Loading...</div></div>
    <div class="profile-row"><div class="muted">Status</div><div id="pStatus">Loading...</div></div>
    <div class="profile-row"><div class="muted">Valid Until</div><div id="pExpiry">Loading...</div></div>
    <div style="margin-top:14px"><button id="logoutBtn" class="btn hang" style="width:100%">Logout</button></div>
  </div>

  <!-- Incoming Call Modal -->
  <div id="incomingModal" style="display:none;align-items:center;justify-content:center" >
    <div class="modalCard">
      <div style="font-weight:700;font-size:18px">Incoming Call</div>
      <div id="incomingFrom" class="muted" style="margin-top:6px">From: —</div>
      <div class="ringDot"></div>
      <div class="modalBtns">
        <button id="answerBtn" class="btn call">Answer</button>
        <button id="declineBtn" class="btn hang">Decline</button>
      </div>
    </div>
  </div>

  <!-- Login Modal (new) -->
  <div id="loginModal" style="display:none;align-items:center;justify-content:center">
    <div class="modalCard">
      <div style="font-weight:700;font-size:18px">Sign in</div>
      <div class="muted" style="margin-top:6px">Sign in with the email & password assigned to you.</div>
      <input id="loginEmail" placeholder="Email" type="email" />
      <input id="loginPassword" placeholder="Password" type="password" />
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="loginBtn" class="btn call" style="flex:1">Login</button>
        <button id="loginCancelBtn" class="btn gray" style="flex:1;display:none">Cancel</button>
      </div>
      <div id="loginError" class="muted" style="color:var(--danger);margin-top:10px;display:none"></div>
    </div>
  </div>

  <!-- Ringtone audio (lightweight) -->
  <audio id="ringtoneAudio" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" preload="auto"></audio>

<script>
/* ================== CONFIG - set this to your backend URL ================== */
const API_BASE = "https://callbridge.onrender.com";

/* small helpers */
const $ = id => document.getElementById(id);
const setText = (id, txt) => { const el = $(id); if (el) el.innerText = txt; };

/* application state */
let device = null;              // Twilio.Device (v2)
let activeConn = null;         // active connection
let incomingConn = null;       // incoming (ringing) connection ref
let currentUser = null;
let assignedNumber = "";
let callStartTs = 0;
let timerInterval = null;
let wfRaf = null;
let historyPollInterval = null;
let localStream = null;        // saved getUserMedia stream to toggle mute/hold

/* Save endpoint - single backend endpoint */
const SAVE_ENDPOINTS = [ (API_BASE || "") + "/save-call" ];

/* ---------- microphone permission ---------- */
async function ensureMic() {
  if (!navigator.mediaDevices || typeof navigator.mediaDevices.getUserMedia !== 'function') {
    console.warn("navigator.mediaDevices.getUserMedia not available.");
    alert("Microphone APIs are not available in this browser. Calls require a microphone.");
    return false;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    // keep reference for mute/hold toggles
    localStream = stream;
    console.log("Microphone available");
    return true;
  } catch (err) {
    console.warn("ensureMic error:", err);
    return false;
  }
}

/* ---------- auth token helpers ---------- */
function getAuthToken() { return localStorage.getItem("auth_token"); }
function setAuthToken(t) { if (t) localStorage.setItem("auth_token", t); else localStorage.removeItem("auth_token"); }
function authHeaders() {
  const t = getAuthToken();
  return t ? { "Authorization": "Bearer " + t } : {};
}

/* ---------- login UI/actions ---------- */
function showLoginModal() { $("loginModal").style.display = "flex"; }
function hideLoginModal() { $("loginModal").style.display = "none"; }

async function performLogin() {
  const email = $("loginEmail").value.trim();
  const password = $("loginPassword").value;
  $("loginError").style.display = "none";
  if (!email || !password) { $("loginError").innerText = "Enter email and password."; $("loginError").style.display = "block"; return; }
  try {
    const res = await fetch(`${API_BASE}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    if (!res.ok) {
      const txt = await res.text();
      $("loginError").innerText = txt || "Login failed";
      $("loginError").style.display = "block";
      return;
    }
    const data = await res.json();
    if (!data || !data.token) {
      $("loginError").innerText = "Invalid login response from server.";
      $("loginError").style.display = "block";
      return;
    }
    // persist token and user for auto-login
    setAuthToken(data.token);
    localStorage.setItem("user", JSON.stringify(data.user));
    currentUser = data.user;
    hideLoginModal();

    // Request mic permission here (user gesture)
    const micOk = await ensureMic();
    if (!micOk) {
      alert("Microphone permission is required for calls. Please allow microphone access.");
    }

    await postLoginInit();
  } catch (e) {
    console.error("Login error:", e);
    $("loginError").innerText = "Network error during login.";
    $("loginError").style.display = "block";
  }
}

async function performLogout() {
  try {
    await fetch(`${API_BASE}/logout`, { method: "POST", headers: Object.assign({ "Content-Type": "application/json" }, authHeaders()) }).catch(()=>{});
  } catch(_) {}
  setAuthToken(null);
  currentUser = null;
  localStorage.removeItem("user");
  if (historyPollInterval) { clearInterval(historyPollInterval); historyPollInterval = null; }
  try { if (device) device.destroy(); } catch(e){}
  device = null;
  showLoginModal();
}

/* ---------- save call to backend (tries one endpoint) ---------- */
async function remoteSaveCall(payload) {
  for (const ep of SAVE_ENDPOINTS) {
    try {
      const res = await fetch(ep, {
        method: "POST",
        headers: Object.assign({ "Content-Type": "application/json" }, authHeaders()),
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        console.log("Saved call to", ep);
        return true;
      } else {
        console.warn("Save endpoint returned", res.status, ep);
      }
    } catch (e) {
      console.warn("Save endpoint failed", ep, e);
    }
  }
  console.warn("All save endpoints failed");
  return false;
}

/* ---------- load user profile from backend ---------- */
async function loadProfile() {
  try {
    const savedUser = JSON.parse(localStorage.getItem("user") || "{}");
    if (!savedUser.email) {
      console.warn("No user in localStorage");
      return;
    }
    const res = await fetch(`${API_BASE}/profile`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: savedUser.email }),
    });
    if (!res.ok) {
      console.warn("Profile fetch failed with", res.status);
      return;
    }
    const p = await res.json();
    console.log("PROFILE RESPONSE:", p);
    currentUser = p;
    setText("pEmail", p.email || "—");
    setText("pNumber", p.assigned_number || "—");
    setText("pStatus", p.role || "Active");
    setText("pExpiry", p.expiry_date ? new Date(p.expiry_date).toLocaleString() : "—");
    assignedNumber = p.assigned_number || "—";
    setText("callerNumber", assignedNumber);
  } catch (e) {
    console.error("loadProfile error", e);
  }
}

/* ---------- initialize Twilio Device by requesting token from backend ---------- */
async function initTwilioDevice() {
  try {
    if (!window.Twilio) {
      console.error("Twilio SDK not available (window.Twilio is undefined).");
      return;
    }

    if (!currentUser || !currentUser.id) {
      console.warn("No currentUser.id when initializing Twilio device. Skipping device init.");
      return;
    }

    const resp = await fetch(`${API_BASE}/twilio-token`, {
      method: "POST",
      headers: Object.assign({ "Content-Type": "application/json" }, authHeaders()),
      body: JSON.stringify({ user_id: currentUser.id })
    });

    if (!resp.ok) {
      const txt = await resp.text();
      console.error("/twilio-token returned", resp.status, txt);
      return;
    }

    const json = await resp.json();
    if (!json || !json.token) {
      console.error("twilio-token returned without token:", json);
      return;
    }

    assignedNumber = json.callerId || assignedNumber;
    setText("callerNumber", assignedNumber || "—");

    // Destroy any existing device
    try { if (device) { device.destroy(); device = null; } } catch(e){ console.warn("Error destroying previous device", e); }

   // --- Wait for Twilio SDK to load before creating device ---
async function safeInitTwilioDevice(json) {
  let retries = 0;
  while ((typeof Twilio === "undefined" || !Twilio.Device) && retries < 10) {
    console.warn("Waiting for Twilio SDK to load...");
    await new Promise(r => setTimeout(r, 500));
    retries++;
  }

  if (typeof Twilio === "undefined" || !Twilio.Device) {
    console.error("❌ Twilio SDK failed to load after waiting.");
    alert("Failed to load Twilio SDK. Please refresh the page.");
    return;
  }

  try {
    // ✅ Create Twilio Device (v2)
    device = new Twilio.Device(json.token, {
      codecPreferences: ["opus", "pcmu"],
      debug: false,
    });

    console.log("✅ Twilio.Device (v2) created");

    device.on("ready", () => {
      console.log("✅ Twilio Device ready");
    });

    device.on("error", (err) => {
      console.error("Twilio Device error:", err);
    });

    // ✅ Incoming call handler
    device.on("incoming", (connection) => {
      console.log("Incoming connection:", connection);
      incomingConn = connection;
      $("incomingFrom").innerText =
        "From: " + (connection.parameters?.From || "Unknown");
      $("incomingModal").style.display = "flex";

      // Play ringtone safely
      try {
        const ringtone = $("ringtoneAudio");
        ringtone.currentTime = 0;
        ringtone.loop = true;
        ringtone.play().catch(e => console.warn("Ringtone play blocked:", e));
      } catch (e) {
        console.warn("Ringtone play error:", e);
      }
    });

    // ✅ Device disconnect handler
    device.on("disconnect", (conn) => {
      console.log("Device disconnect event:", conn);
    });

  } catch (err) {
    console.error("initTwilioDevice error:", err);
  }
}


/* ---------- start outgoing call ---------- */
async function startCall() {
  const number = $("dialInput").value.trim();
  if (!number) return alert("Enter a number to call.");

  // Ensure mic permission & device initialization on user gesture
  if (!localStream) {
    const ok = await ensureMic();
    if (!ok) return alert("Microphone permission is required to place calls.");
  }
  if (!device) {
    await initTwilioDevice();
    if (!device) return alert("Twilio Device initialization failed. See console.");
  }

  try {
    await remoteSaveCall({ user_email: currentUser && currentUser.email, call_type: "outgoing", phone_number: number, status: "initiated", created_at: new Date().toISOString() });

    // Connect with params (v2)
    const conn = device.connect({ params: { To: number } });
    activeConn = conn || null;

    // UI changes
    $("dialpadArea").style.display = "none";
    $("activeArea").style.display = "flex";
    $("hangupBtn").style.display = "inline-block";
    setText("activeLabel", number || "In Call");
    startTimer();
    renderWaveform();

    // Attempt to stop ringtone if any
    try { $("ringtoneAudio").pause(); $("ringtoneAudio").currentTime = 0; } catch(e){}

    // Wire events on connection
    if (activeConn && typeof activeConn.on === 'function') {
      activeConn.on("accept", () => {
        console.log("Call accepted");
        callStartTs = Date.now();
      });

      activeConn.on("disconnect", async () => {
        const duration = Math.max(0, Math.floor((Date.now() - callStartTs) / 1000));
        await remoteSaveCall({
          user_email: currentUser && currentUser.email,
          call_type: "outgoing",
          phone_number: number,
          status: "completed",
          created_at: new Date().toISOString(),
          duration
        });
        stopCallUI();
        refreshHistory();
      });

      activeConn.on("error", (err) => {
        console.error("connection error", err);
        stopCallUI();
      });
    }

  } catch (e) {
    console.error("startCall error", e);
    alert("Failed to start call. See console for details.");
  }
}

/* ---------- answer / decline incoming ---------- */
async function answerIncoming() {
  if (!incomingConn) return;
  try {
    // stop ringtone
    try { $("ringtoneAudio").pause(); $("ringtoneAudio").currentTime = 0; } catch(e){}
    // close modal
    $("incomingModal").style.display = "none";

    // ensure mic permission (user gesture)
    if (!localStream) {
      const ok = await ensureMic();
      if (!ok) { alert("Microphone permission required to answer."); return; }
    }

    // Accept the call
    if (typeof incomingConn.accept === 'function') {
      incomingConn.accept();
    } else if (typeof incomingConn.acceptConnection === 'function') {
      incomingConn.acceptConnection();
    } else {
      console.warn("No accept function on incoming connection");
    }

    activeConn = incomingConn;
    incomingConn = null;

    // Update UI
    $("dialpadArea").style.display = "none";
    $("activeArea").style.display = "flex";
    $("hangupBtn").style.display = "inline-block";
    setText("activeLabel", activeConn.parameters?.From || "In Call");
    startTimer();
    renderWaveform();

    // Save answered incoming call
    await remoteSaveCall({ user_email: currentUser && currentUser.email, call_type: "incoming", phone_number: activeConn.parameters?.From || "", status: "answered", created_at: new Date().toISOString() });

    // wire disconnect handler
    if (activeConn && typeof activeConn.on === 'function') {
      activeConn.on("disconnect", async () => {
        const duration = Math.max(0, Math.floor((Date.now() - callStartTs) / 1000));
        await remoteSaveCall({
          user_email: currentUser && currentUser.email,
          call_type: "incoming",
          phone_number: activeConn.parameters?.From || "",
          status: "completed",
          created_at: new Date().toISOString(),
          duration
        });
        stopCallUI();
        refreshHistory();
      });
    }

  } catch (e) { console.warn("Error accepting incoming:", e); }
}

async function declineIncoming() {
  if (!incomingConn) return;
  try {
    try { $("ringtoneAudio").pause(); $("ringtoneAudio").currentTime = 0; } catch(e){}
    if (typeof incomingConn.reject === 'function') incomingConn.reject();
    else if (typeof incomingConn.rejectConnection === 'function') incomingConn.rejectConnection();
    else console.warn("No reject function on incoming connection");
  } catch (e) { console.warn("Error rejecting incoming:", e); }
  $("incomingModal").style.display = "none";
  await remoteSaveCall({ user_email: currentUser && currentUser.email, call_type: "incoming", phone_number: incomingConn.parameters?.From || "", status: "missed", created_at: new Date().toISOString(), duration: 0 });
  incomingConn = null;
}

/* ---------- hangup ---------- */
function hangUp() {
  try {
    if (activeConn && typeof activeConn.disconnect === 'function') {
      activeConn.disconnect();
    } else if (device && typeof device.disconnectAll === 'function') {
      device.disconnectAll();
    }
  } catch (e) { console.warn("hangUp error:", e); }
  stopCallUI();
}

/* ---------- stop call UI ---------- */
function stopCallUI() {
  $("dialpadArea").style.display = "flex";
  $("activeArea").style.display = "none";
  $("hangupBtn").style.display = "none";
  clearWaveform();
  stopTimer();
  activeConn = null;
}

/* ---------- mute / hold (local) ---------- */
function toggleMute() {
  if (!activeConn && !localStream) return;
  try {
    if (activeConn && typeof activeConn.mute === "function") {
      const isMuted = typeof activeConn.isMuted === 'function' ? activeConn.isMuted() : !!activeConn._muted;
      activeConn.mute(!isMuted);
      $("muteBtn").innerText = (!isMuted) ? "Unmute" : "Mute";
      return;
    }
    const s = localStream || (activeConn && (activeConn.mediaStream || activeConn._mediaStream));
    if (s && s.getAudioTracks) {
      const currentlyEnabled = s.getAudioTracks()[0].enabled;
      s.getAudioTracks().forEach(t => t.enabled = !currentlyEnabled);
      $("muteBtn").innerText = currentlyEnabled ? "Unmute" : "Mute";
    }
  } catch (e) { console.warn(e); }
}

function toggleHold() {
  if (!activeConn && !localStream) return;
  try {
    const s = localStream || (activeConn && (activeConn.mediaStream || activeConn._mediaStream));
    if (s && s.getAudioTracks) {
      const currentlyEnabled = s.getAudioTracks()[0].enabled;
      s.getAudioTracks().forEach(t => t.enabled = !currentlyEnabled);
      $("holdBtn").innerText = (!currentlyEnabled) ? "Resume" : "Hold";
    }
  } catch (e) { console.warn(e); }
}

/* ---------- waveform ---------- */
function renderWaveform() {
  const wrap = $("waveWrap");
  wrap.innerHTML = "";
  for (let i = 0; i < 6; i++) {
    const b = document.createElement("div");
    b.style.width = '6px';
    b.style.background = '#60a5fa';
    b.style.borderRadius = '3px';
    b.style.height = (8 + Math.random() * 30) + "px";
    b.style.transition = 'height 120ms';
    wrap.appendChild(b);
  }
  (function animate() {
    const bars = wrap.children;
    for (let i = 0; i < bars.length; i++) bars[i].style.height = (8 + Math.random() * 36) + "px";
    wfRaf = requestAnimationFrame(animate);
  })();
  wrap.style.display = "flex";
}
function clearWaveform() {
  if (wfRaf) cancelAnimationFrame(wfRaf);
  $("waveWrap").innerHTML = "";
  $("waveWrap").style.display = "none";
}

/* ---------- timer ---------- */
function startTimer() {
  callStartTs = Date.now();
  stopTimer();
  timerInterval = setInterval(() => {
    const s = Math.floor((Date.now() - callStartTs) / 1000);
    const mm = String(Math.floor(s / 60)).padStart(2, '0');
    const ss = String(s % 60).padStart(2, '0');
    setText("callTimer", mm + ":" + ss);
  }, 500);
}
function stopTimer() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; setText("callTimer", "00:00"); }
}

/* ---------- refresh history (via backend) ---------- */
async function refreshHistory() {
  try {
    if (!currentUser) return;
    const res = await fetch((API_BASE || "") + "/calls", {
      method: "GET",
      headers: Object.assign({}, authHeaders())
    });
    if (!res.ok) {
      console.warn("Failed to load calls", res.status);
      $("historyList").innerHTML = '<div class="muted">No calls yet</div>';
      return;
    }
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) {
      $("historyList").innerHTML = '<div class="muted">No calls yet</div>';
      return;
    }
    renderHistoryItems(data);
  } catch (e) {
    console.error("refreshHistory error", e);
    $("historyList").innerHTML = '<div class="muted">Error loading history</div>';
  }
}
function renderHistoryItems(items) {
  const container = $("historyList");
  container.innerHTML = "";
  items.forEach(it => {
    const div = document.createElement("div"); div.className = "history-item";
    const left = document.createElement("div"); left.style.display = "flex"; left.style.flexDirection = "column";
    const badge = document.createElement("div"); badge.className = "badge"; badge.innerText = (it.call_type || it.type || 'UNKNOWN').toUpperCase();
    const main = document.createElement("div"); main.style.fontWeight = 700; main.innerText = (it.phone_number || it.other_number || it.to_number || it.from_number || '—');
    const sub = document.createElement("div"); sub.className = "muted"; sub.style.fontSize = '12px'; sub.innerText = it.status || '';
    left.appendChild(badge); left.appendChild(main); left.appendChild(sub);

    const right = document.createElement("div"); right.style.textAlign = 'right';
    right.innerHTML = `<div class="muted">${new Date(it.created_at || it.started_at || Date.now()).toLocaleString()}</div><div style="font-weight:700;margin-top:6px">${(it.duration || 0)} s</div>`;
    div.appendChild(left); div.appendChild(right);
    container.appendChild(div);
  });
}

/* ---------- simple polling "realtime" fallback ---------- */
function startHistoryPolling() {
  if (historyPollInterval) clearInterval(historyPollInterval);
  historyPollInterval = setInterval(refreshHistory, 8000);
}
function stopHistoryPolling() {
  if (historyPollInterval) clearInterval(historyPollInterval);
  historyPollInterval = null;
}

/* ---------- UI wiring ---------- */
document.addEventListener("click", (e) => {
  const k = e.target.closest("[data-key]");
  if (k) $("dialInput").value += k.getAttribute("data-key");
});
$("startCallBtn").addEventListener("click", startCall);
$("hangupBtn").addEventListener("click", hangUp);
$("muteBtn").addEventListener("click", toggleMute);
$("holdBtn").addEventListener("click", toggleHold);
$("answerBtn").addEventListener("click", answerIncoming);
$("declineBtn").addEventListener("click", declineIncoming);
$("logoutBtn").addEventListener("click", async () => { await performLogout(); });

/* Login modal listeners */
$("loginBtn").addEventListener("click", performLogin);
$("loginPassword")?.addEventListener && $("loginPassword").addEventListener("keydown", (e)=>{ if(e.key === "Enter") performLogin(); });

/* ---------- after login initialization ---------- */
async function postLoginInit() {
  try {
    await loadProfile();
    // Initialize Twilio Device now (mic permission should already have been requested during login)
    await initTwilioDevice();
    await refreshHistory();
    startHistoryPolling();
  } catch (e) {
    console.error("postLoginInit error", e);
  }
}

/* ---------- app init (auto-login) ---------- */
async function init() {
  try {
    // If auth token + user present in localStorage => auto-login
    const token = getAuthToken();
    const savedUser = JSON.parse(localStorage.getItem("user") || "{}");

    if (token && savedUser.email) {
      console.log("🔁 Auto-login from localStorage");
      currentUser = savedUser;
      await loadProfile();
      await refreshHistory();

      // At auto-login: attempt to get mic permission now — if blocked by browser, wait for first user gesture
      try {
        const micOk = await ensureMic();
        if (micOk) {
          await initTwilioDevice();
        } else {
          console.warn("Mic permission not granted during auto-login — Twilio device will be initialized on first user gesture.");
          const gestureInit = async () => {
            document.removeEventListener("click", gestureInit);
            const ok = await ensureMic();
            if (ok) await initTwilioDevice();
          };
          document.addEventListener("click", gestureInit);
        }
      } catch(e) {
        console.warn("Auto-login mic check failed:", e);
        const gestureInit = async () => {
          document.removeEventListener("click", gestureInit);
          const ok = await ensureMic();
          if (ok) await initTwilioDevice();
        };
        document.addEventListener("click", gestureInit);
      }

      startHistoryPolling();
      return;
    }

    console.warn("No saved session, showing login modal");
    showLoginModal();
  } catch (err) {
    console.error("App init error:", err);
    showLoginModal();
  }
}

init();
</script>
</body>
</html>
