<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Call Bridge â€” Tech Talk Titans</title>

  <!-- Twilio Client SDK (v1.13) -->
  <script src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>

  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --green:#10b981;
      --danger:#ef4444; --shadow:0 8px 30px rgba(2,6,23,0.08);
    }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Arial;}
    html,body{height:100%;margin:0;background:var(--bg)}
    body{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;padding:18px}

    .panel{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);height:calc(100vh - 36px);overflow:auto}
    h2{margin:0 0 8px 0}
    .muted{color:var(--muted);font-size:13px}

    #left{display:flex;flex-direction:column;gap:12px;align-items:center}
    #callerNumber{font-weight:700;color:#111827;}
    input#dialInput{width:220px;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:16px}

    .key-row{display:flex;gap:8px;margin-top:8px}
    .key{width:64px;height:64px;border-radius:10px;border:1px solid #e6e9ef;background:#fafbff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .key.primary{background:var(--accent);color:#fff;border:none}

    .controls{display:flex;gap:10px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;color:#fff}
    .btn.call{background:var(--green)} .btn.hang{background:var(--danger)} .btn.gray{background:#374151}

    #activeArea{display:none;flex-direction:column;align-items:center;gap:8px}
    #waveWrap{display:flex;gap:6px;align-items:flex-end;height:40px}

    #historyList{display:flex;flex-direction:column;gap:10px}
    .history-item{padding:10px;border-radius:10px;border:1px solid #eef2ff;background:#fff;display:flex;justify-content:space-between;align-items:center}
    .badge{padding:6px 8px;border-radius:999px;background:#f1f5f9;font-size:12px;color:var(--muted)}

    .profile-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #f3f4f6}

    #incomingModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:9999;align-items:center;justify-content:center}
    .modalCard{background:white;padding:22px;border-radius:12px;width:360px;text-align:center;box-shadow:0 12px 40px rgba(2,6,23,0.12)}
    .modalBtns{display:flex;gap:12px;justify-content:center;margin-top:12px}

    @keyframes pulse {
      0%{transform:scale(0.95);opacity:0.8}50%{transform:scale(1.08);opacity:1}100%{transform:scale(0.95);opacity:0.8}
    }

    .ringDot{width:72px;height:72px;border-radius:50%;background:var(--green);margin:10px auto;animation:pulse 1.2s infinite}
    @media (max-width:900px){body{grid-template-columns:1fr;}}

    #loginModal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.5);z-index:10000;align-items:center;justify-content:center}
    #loginModal .modalCard{width:360px;text-align:left;}
    #loginModal input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-top:8px;}
  </style>
</head>
<body>

  <!-- LEFT PANEL -->
  <div id="left" class="panel">
    <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
      <h2>Call Bridge</h2>
      <div class="muted">Tech Talk Titans</div>
    </div>
    <div style="text-align:center">
      <div class="muted">Your Virtual Number</div>
      <div id="callerNumber">Loading...</div>
    </div>

    <div id="dialpadArea" style="display:flex;flex-direction:column;align-items:center;margin-top:6px">
      <input id="dialInput" placeholder="+1..." />
      <div style="margin-top:12px">
        <div class="key-row">
          <button class="key" data-key="1">1</button><button class="key" data-key="2">2</button><button class="key" data-key="3">3</button>
        </div>
        <div class="key-row">
          <button class="key" data-key="4">4</button><button class="key" data-key="5">5</button><button class="key" data-key="6">6</button>
        </div>
        <div class="key-row">
          <button class="key" data-key="7">7</button><button class="key" data-key="8">8</button><button class="key" data-key="9">9</button>
        </div>
        <div class="key-row">
          <button class="key" data-key=""></button><button class="key" data-key="0">0</button><button class="key" data-key="#">#</button>
        </div>
      </div>
      <div class="controls" style="margin-top:12px">
        <button id="startCallBtn" class="btn call">ðŸ“ž Call</button>
        <button id="hangupBtn" class="btn hang" style="display:none">âœ– Hangup</button>
      </div>
    </div>

    <div id="activeArea">
      <div id="activeLabel" style="font-weight:700">In Call</div>
      <div id="callTimer" class="muted">00:00</div>
      <div id="waveWrap"></div>
      <div class="controls" style="margin-top:10px">
        <button id="muteBtn" class="btn gray">Mute</button>
        <button id="holdBtn" class="btn gray">Hold</button>
      </div>
    </div>
  </div>

  <!-- MIDDLE PANEL -->
  <div id="middle" class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Call History</h2><div class="muted">Latest</div>
    </div>
    <div id="historyList" style="margin-top:12px"><div class="muted">Loading call history...</div></div>
  </div>

  <!-- RIGHT PANEL -->
  <div id="right" class="panel">
    <h2>My Profile</h2>
    <div class="profile-row"><div class="muted">Email</div><div id="pEmail">Loading...</div></div>
    <div class="profile-row"><div class="muted">Assigned Number</div><div id="pNumber">Loading...</div></div>
    <div class="profile-row"><div class="muted">Status</div><div id="pStatus">Loading...</div></div>
    <div class="profile-row"><div class="muted">Valid Until</div><div id="pExpiry">Loading...</div></div>
    <div style="margin-top:14px"><button id="logoutBtn" class="btn hang" style="width:100%">Logout</button></div>
  </div>

  <!-- Incoming Modal -->
  <div id="incomingModal" style="display:none;align-items:center;justify-content:center">
    <div class="modalCard">
      <div style="font-weight:700;font-size:18px">Incoming Call</div>
      <div id="incomingFrom" class="muted" style="margin-top:6px">From: â€”</div>
      <div class="ringDot"></div>
      <div class="modalBtns">
        <button id="answerBtn" class="btn call">Answer</button>
        <button id="declineBtn" class="btn hang">Decline</button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" style="display:none;align-items:center;justify-content:center">
    <div class="modalCard">
      <div style="font-weight:700;font-size:18px">Sign in</div>
      <div class="muted" style="margin-top:6px">Sign in with your assigned credentials.</div>
      <input id="loginEmail" placeholder="Email" type="email" />
      <input id="loginPassword" placeholder="Password" type="password" />
      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="loginBtn" class="btn call" style="flex:1">Login</button>
      </div>
      <div id="loginError" class="muted" style="color:var(--danger);margin-top:10px;display:none"></div>
    </div>
  </div>

<script>
const API_BASE = "https://callbridge.onrender.com";
const $ = id => document.getElementById(id);
const setText = (id, txt) => { const el = $(id); if (el) el.innerText = txt; };

let device = null, activeConn = null, incomingConn = null, currentUser = null;
let assignedNumber = "", callStartTs = 0, timerInterval = null, wfRaf = null, historyPollInterval = null;

function getAuthToken() { return localStorage.getItem("auth_token"); }
function setAuthToken(t) { if (t) localStorage.setItem("auth_token", t); else localStorage.removeItem("auth_token"); }
function authHeaders() { const t = getAuthToken(); return t ? { "Authorization": "Bearer " + t } : {}; }

/* LOGIN */
function showLoginModal(){ $("loginModal").style.display="flex"; }
function hideLoginModal(){ $("loginModal").style.display="none"; }
async function performLogin(){
  const email=$("loginEmail").value.trim(), password=$("loginPassword").value;
  $("loginError").style.display="none";
  if(!email||!password){$("loginError").innerText="Enter email and password."; $("loginError").style.display="block"; return;}
  try{
    const res=await fetch(`${API_BASE}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,password})});
    if(!res.ok){$("loginError").innerText="Invalid credentials";$("loginError").style.display="block";return;}
    const data=await res.json();
    setAuthToken(data.token); localStorage.setItem("user",JSON.stringify(data.user));
    currentUser=data.user; hideLoginModal(); await postLoginInit();
  }catch(e){$("loginError").innerText="Network error";$("loginError").style.display="block";}
}
$("loginBtn").addEventListener("click",performLogin);
$("loginPassword").addEventListener("keydown",e=>{if(e.key==="Enter")performLogin();});

/* PROFILE */
async function loadProfile(){
  try{
    const saved=JSON.parse(localStorage.getItem("user")||"{}");
    const res=await fetch(`${API_BASE}/profile`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:saved.email})});
    const p=await res.json(); currentUser=p;
    setText("pEmail",p.email); setText("pNumber",p.assigned_number); setText("pStatus",p.role||"Active");
    setText("pExpiry",p.expiry_date?new Date(p.expiry_date).toLocaleString():"â€”");
    assignedNumber=p.assigned_number; setText("callerNumber",assignedNumber);
  }catch(e){console.error(e);}
}

/* âœ… CLEAN Twilio INIT */
async function initTwilioDevice(){
  try{
    if(!currentUser?.id)return;
    const resp=await fetch(`${API_BASE}/twilio-token`,{
      method:"POST",headers:Object.assign({"Content-Type":"application/json"},authHeaders()),
      body:JSON.stringify({user_id:currentUser.id})
    });
    const json=await resp.json();
    if(!json?.token)return console.error("No token");
    assignedNumber=json.callerId||assignedNumber; setText("callerNumber",assignedNumber||"â€”");

    device=new Twilio.Device(json.token,{codecPreferences:["opus","pcmu"],debug:true});
    device.on("ready",()=>console.log("âœ… Twilio ready"));
    device.on("error",err=>console.error("âŒ Twilio error:",err));
    device.on("incoming",onDeviceIncoming);
    device.on("connect",onDeviceConnect);
    device.on("disconnect",onDeviceDisconnect);
  }catch(e){console.error("Twilio init failed",e);}
}

/* CALL ACTIONS */
async function startCall(){
  const number=$("dialInput").value.trim();
  if(!number)return alert("Enter number");
  if(!device)return alert("Device not ready");
  await remoteSaveCall({user_email:currentUser.email,call_type:"outgoing",phone_number:number,status:"initiated",created_at:new Date().toISOString()});
  device.connect({To:number});
}
function hangUp(){ if(device?.disconnectAll) device.disconnectAll(); stopCallUI(); }

/* INCOMING */
function onDeviceIncoming(call){
  incomingConn=call; $("incomingFrom").innerText="From: "+(call.parameters.From||"Unknown");
  $("incomingModal").style.display="flex";
}
async function answerIncoming(){incomingConn.accept();$("incomingModal").style.display="none";}
async function declineIncoming(){incomingConn.reject();$("incomingModal").style.display="none";}

/* CONNECTION */
function onDeviceConnect(conn){
  activeConn=conn; $("dialpadArea").style.display="none"; $("activeArea").style.display="flex"; $("hangupBtn").style.display="inline-block";
  setText("activeLabel",conn.parameters?.To||conn.parameters?.From||"In Call");
  startTimer(); renderWaveform();
  conn.on("disconnect",()=>{stopCallUI();refreshHistory();});
}
function onDeviceDisconnect(){stopCallUI();}

/* UI ACTIONS */
$("startCallBtn").addEventListener("click",startCall);
$("hangupBtn").addEventListener("click",hangUp);
$("answerBtn").addEventListener("click",answerIncoming);
$("declineBtn").addEventListener("click",declineIncoming);

/* HISTORY + MISC */
async function remoteSaveCall(p){try{await fetch(`${API_BASE}/save-call`,{method:"POST",headers:Object.assign({"Content-Type":"application/json"},authHeaders()),body:JSON.stringify(p)});}catch{}}
async function refreshHistory(){try{const r=await fetch(`${API_BASE}/calls`,{headers:authHeaders()});const d=await r.json();renderHistoryItems(d);}catch{}}
function renderHistoryItems(items){
  const c=$("historyList");c.innerHTML="";
  items.forEach(it=>{
    const div=document.createElement("div");div.className="history-item";
    div.innerHTML=`<div><div class="badge">${it.call_type}</div><div style="font-weight:700">${it.phone_number}</div><div class="muted">${it.status}</div></div>
    <div style="text-align:right"><div class="muted">${new Date(it.created_at).toLocaleString()}</div><div style="font-weight:700">${it.duration||0}s</div></div>`;
    c.appendChild(div);
  });
}

/* TIMER + WAVEFORM */
function startTimer(){callStartTs=Date.now();stopTimer();timerInterval=setInterval(()=>{const s=Math.floor((Date.now()-callStartTs)/1000);
  const mm=String(Math.floor(s/60)).padStart(2,"0"),ss=String(s%60).padStart(2,"0");setText("callTimer",mm+":"+ss);},500);}
function stopTimer(){if(timerInterval)clearInterval(timerInterval);setText("callTimer","00:00");}
function renderWaveform(){const wrap=$("waveWrap");wrap.innerHTML="";for(let i=0;i<6;i++){const b=document.createElement("div");b.style.width="6px";b.style.background="#60a5fa";b.style.borderRadius="3px";b.style.height=(8+Math.random()*30)+"px";wrap.appendChild(b);}
(function animate(){for(const b of wrap.children)b.style.height=(8+Math.random()*36)+"px";wfRaf=requestAnimationFrame(animate);})();}
function clearWaveform(){if(wfRaf)cancelAnimationFrame(wfRaf);$("waveWrap").innerHTML="";}

/* INIT */
async function postLoginInit(){await loadProfile();await initTwilioDevice();await refreshHistory();}
async function init(){const token=getAuthToken();const user=JSON.parse(localStorage.getItem("user")||"{}");if(token&&user.email){currentUser=user;await postLoginInit();}else showLoginModal();}
init();
</script>
</body>
</html>
